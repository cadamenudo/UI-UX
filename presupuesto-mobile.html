<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Presupuesto móvil – Cada Menudo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Nunito -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
  body {
    font-family: Nunito, sans-serif;
    background: #F6F7FF;
    padding: 16px;
    margin: 0;
  }

  /* HEADER */
  .top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  h1 {
    font-size: 1.4rem;
    font-weight: 800;
    margin: 0;
  }

  .toggle {
    background: white;
    border-radius: 999px;
    padding: 4px;
    display: flex;
    gap: 4px;
    border: 1px solid #E5E7EB;
  }

  .toggle span {
    padding: 6px 14px;
    border-radius: 999px;
    cursor: pointer;
    font-size: 0.85rem;
  }

  .toggle .active {
    background: #E8ECFF;
    color: #3956E8;
    font-weight: 700;
  }

  .select-month {
    background: white;
    padding: 8px 14px;
    border-radius: 10px;
    border: 1px solid #E5E7EB;
    font-size: 0.9rem;
    margin-bottom: 14px;
    margin-top: 4px;
    width: 100%;
  }

  /* SECCIONES PRESUPUESTO (ACORDEÓN) */
  .section {
    background: white;
    padding: 10px 14px;
    border-radius: 14px;
    margin-bottom: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  }

  .section.ingresos {
    border-left: 4px solid #22C55E;
  }
  .section.gastos {
    border-left: 4px solid #F97316;
  }
  .section.ahorro {
    border-left: 4px solid #3B82F6;
  }

  .section-header-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
  }

  .section-header {
    font-weight: 700;
    font-size: 1rem;
  }

  .section-label {
    font-size: 0.8rem;
    color: #64748B;
    margin-top: 2px;
  }

  .accordion-right {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .section-summary {
    font-size: 0.8rem;
    color: #64748B;
  }

  .accordion-icon {
    font-size: 0.9rem;
    transition: transform 0.2s ease;
  }

  .section.collapsed .accordion-icon {
    transform: rotate(-90deg);
  }

  .section-body {
    margin-top: 6px;
  }

  .section.collapsed .section-body {
    display: none;
  }

  .add-btn-small {
    border: none;
    background: #EEF2FF;
    color: #3956E8;
    font-size: 0.8rem;
    padding: 5px 10px;
    border-radius: 999px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    margin-bottom: 4px;
  }

  .row {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
    font-size: 0.95rem;
    cursor: default;
  }

  .row span:last-child {
    font-weight: 600;
  }

  /* GRUPOS POR CATEGORÍA */
  .cat-group {
    background: #F9FAFB;
    border-radius: 10px;
    padding: 4px 6px;
    margin-bottom: 4px;
  }

  .cat-group-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    padding: 4px 2px;
  }

  .cat-group-title {
    display: flex;
    flex-direction: column;
  }

  .cat-group-name {
    font-size: 0.95rem;
    font-weight: 600;
  }

  .cat-group-summary {
    font-size: 0.8rem;
    color: #64748B;
  }

  .cat-group-total {
    font-weight: 700;
    font-size: 0.95rem;
  }

  .cat-group-arrow {
    font-size: 0.85rem;
    margin-left: 6px;
    transition: transform 0.2s ease;
  }

  .cat-group.collapsed .cat-group-body {
    display: none;
  }

  .cat-group.collapsed .cat-group-arrow {
    transform: rotate(-90deg);
  }

  .cat-group-body {
    margin-top: 2px;
    padding-top: 2px;
    border-top: 1px dashed #E5E7EB;
  }

  .cat-sub-row {
    display: flex;
    justify-content: space-between;
    padding: 3px 0;
    font-size: 0.85rem;
    cursor: pointer;
  }

  .cat-sub-row span:last-child {
    font-weight: 600;
  }

  /* TOTALES */
  .totals {
    margin-top: 4px;
    margin-bottom: 12px;
    background: #E8ECFF;
    padding: 12px 14px;
    border-radius: 14px;
    border: 1px solid #C7D2FE;
    box-shadow: 0 2px 6px rgba(0,0,0,0.04);
  }

  .totals .row span:first-child {
    color: #4B5563;
    font-weight: 500;
  }

  .totals .row span:last-child {
    color: #111827;
  }

  .save {
    margin-top: 8px;
    width: 100%;
    padding: 14px;
    background: #7459D9;
    color: white;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 700;
    border: none;
    cursor: pointer;
  }

  /* CARD BASE */
  .card {
    background: white;
    padding: 14px;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    margin-bottom: 14px;
  }

  /* Comparativo separado visualmente del botón guardar */
  .card.comp-card {
    margin-top: 16px;
  }

  /* COMPARATIVO */
  .comp-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .comp-title {
    font-weight: 800;
    font-size: 1rem;
  }

  .chips {
    display: flex;
    gap: 6px;
  }

  .chip {
    border-radius: 999px;
    border: 1px solid #E5E7EB;
    padding: 4px 10px;
    font-size: 0.8rem;
    cursor: pointer;
    background: #FFFFFF;
    color: #64748B;
  }

  .chip.active {
    border-color: #3956E8;
    background: #E8ECFF;
    color: #3956E8;
    font-weight: 700;
  }

  /* BANNER ESTADO */
  .status-banner {
    border-radius: 12px;
    padding: 8px 10px;
    font-size: 0.85rem;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .status-banner.green {
    background: #ECFDF3;
    color: #15803D;
  }
  .status-banner.yellow {
    background: #FEF9C3;
    color: #92400E;
  }
  .status-banner.red {
    background: #FEF2F2;
    color: #B91C1C;
  }

  .status-banner strong {
    font-weight: 800;
  }

  /* MINI RESUMEN */
  .mini-summary {
    margin-bottom: 8px;
  }

  .mini-summary .row {
    font-size: 0.9rem;
    cursor: default;
  }

  .mini-summary .row span:first-child {
    color: #64748B;
  }

  /* Colores para la diferencia */
  #miniDiff.diff-positive {
    color: #15803D; /* verde */
  }

  #miniDiff.diff-negative {
    color: #B91C1C; /* rojo */
  }

  #barComp {
    width: 100%;
    height: 260px;
    margin-top: 4px;
    margin-bottom: 8px;
  }

  canvas {
    max-height: 260px;
    display: block;
  }

  /* DESVIACIONES TOP */
  .top-deviations {
    border-top: 1px dashed #E5E7EB;
    padding-top: 6px;
    margin-top: 4px;
    font-size: 0.85rem;
  }

  .top-dev-item {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
  }

  .top-dev-left {
    display: flex;
    flex-direction: column;
  }

  .top-dev-name {
    font-weight: 600;
  }

  .top-dev-detail {
    color: #64748B;
    font-size: 0.8rem;
  }

  .top-dev-diff.positive {
    color: #B91C1C;
    font-weight: 700;
  }
  .top-dev-diff.negative {
    color: #15803D;
    font-weight: 700;
  }

  /* MODAL AÑADIR / EDITAR */
  .modal {
    position: fixed;
    inset: 0;
    background: rgba(15,23,42,0.45);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 999;
  }

  .modal.open {
    display: flex;
  }

  .modal-content {
    background: #fff;
    border-radius: 16px;
    padding: 1.5rem 1.6rem;
    width: 90%;
    max-width: 380px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.25);
  }

  .modal-content h2 {
    margin-top: 0;
    font-size: 1.1rem;
    color: #111827;
    font-weight: 800;
    margin-bottom: 1rem;
  }

  .modal-content label {
    display: block;
    font-weight: 600;
    font-size: 0.85rem;
    margin-bottom: 0.25rem;
    margin-top: 0.4rem;
    color: #111827;
  }

  .modal-content input,
  .modal-content select,
  .modal-content textarea {
    width: 100%;
    padding: 0.7rem 0.8rem;
    border: 1px solid #D1D5DB;
    border-radius: 12px;
    font-size: 0.9rem;
    font-family: inherit;
    box-sizing: border-box;
    margin-bottom: 0.3rem;
  }

  .modal-content textarea {
    resize: vertical;
    min-height: 60px;
  }

  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-top: 0.8rem;
  }

  .btn-cancel {
    border: none;
    background: #F3F4F6;
    color: #111827;
    padding: 0.6rem 1.1rem;
    border-radius: 10px;
    font-size: 0.85rem;
    cursor: pointer;
  }

  .btn-save {
    border: none;
    background: #3956E8;
    color: white;
    padding: 0.6rem 1.3rem;
    border-radius: 10px;
    font-size: 0.85rem;
    font-weight: 700;
    cursor: pointer;
  }
  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="top">
    <h1>Presupuesto</h1>
    <div class="toggle" id="toggleTipo">
      <span data-tipo="mensual" class="active">Mensual</span>
      <span data-tipo="anual">Anual</span>
    </div>
  </div>

  <select class="select-month" id="selectMonth">
    <option>Enero 2025</option>
    <option>Febrero 2025</option>
    <option>Marzo 2025</option>
  </select>

  <!-- SECCION INGRESOS (ACORDEÓN) -->
  <section class="section ingresos collapsed">
    <div class="section-header-row accordion-header" data-area="ingresos">
      <div>
        <div class="section-header">Ingresos</div>
        <div class="section-label">Lo que entra en el periodo</div>
      </div>
      <div class="accordion-right">
        <span class="section-summary" id="resumenIngresos">$0.00</span>
        <span class="accordion-icon">⌄</span>
      </div>
    </div>
    <div class="section-body">
      <button class="add-btn-small" data-area="ingresos">
        + Añadir
      </button>
      <div id="listaIngresos"></div>
    </div>
  </section>

  <!-- SECCION GASTOS (ACORDEÓN) -->
  <section class="section gastos collapsed">
    <div class="section-header-row accordion-header" data-area="gastos">
      <div>
        <div class="section-header">Gastos</div>
        <div class="section-label">Lo que sale en el periodo</div>
      </div>
      <div class="accordion-right">
        <span class="section-summary" id="resumenGastos">$0.00</span>
        <span class="accordion-icon">⌄</span>
      </div>
    </div>
    <div class="section-body">
      <button class="add-btn-small" data-area="gastos">
        + Añadir
      </button>
      <div id="listaGastos"></div>
    </div>
  </section>

  <!-- SECCION AHORRO (ACORDEÓN) -->
  <section class="section ahorro collapsed">
    <div class="section-header-row accordion-header" data-area="ahorro">
      <div>
        <div class="section-header">Ahorro</div>
        <div class="section-label">Lo que apartas del ingreso</div>
      </div>
      <div class="accordion-right">
        <span class="section-summary" id="resumenAhorro">$0.00</span>
        <span class="accordion-icon">⌄</span>
      </div>
    </div>
    <div class="section-body">
      <button class="add-btn-small" data-area="ahorro">
        + Añadir
      </button>
      <div id="listaAhorro"></div>
    </div>
  </section>

  <!-- TOTALES -->
  <section class="totals">
    <div class="row">
      <span>Total ingresos</span>
      <span id="totalIngresos">$0.00</span>
    </div>
    <div class="row">
      <span>Total gastos</span>
      <span id="totalGastos">$0.00</span>
    </div>
    <div class="row">
      <span>Total ahorro</span>
      <span id="totalAhorro">$0.00</span>
    </div>
    <div class="row">
      <span>Disponible</span>
      <span id="totalDisponible">$0.00</span>
    </div>
  </section>

  <button class="save">Guardar presupuesto</button>

  <!-- COMPARATIVO -->
  <section class="card comp-card">
    <div class="comp-header">
      <div class="comp-title">Comparar presupuesto vs real</div>
      <div class="chips" id="chipsArea">
        <button class="chip active" data-area="ingresos">Ingresos</button>
        <button class="chip" data-area="gastos">Gastos</button>
        <button class="chip" data-area="ahorro">Ahorro</button>
      </div>
    </div>

    <div id="statusBanner" class="status-banner green">
      <span><strong>Vas bien.</strong> Por debajo del presupuesto.</span>
      <span id="bannerPct">90%</span>
    </div>

    <div class="mini-summary">
      <div class="row">
        <span>Presupuesto</span>
        <span id="miniPres">$0.00</span>
      </div>
      <div class="row">
        <span>Real</span>
        <span id="miniReal">$0.00</span>
      </div>
      <div class="row">
        <span>Diferencia</span>
        <span id="miniDiff">$0.00</span>
      </div>
    </div>

    <canvas id="barComp"></canvas>

    <div class="top-deviations" id="topDeviations"></div>
  </section>

  <!-- MODAL AÑADIR / EDITAR -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <h2 id="modalTitle">Añadir</h2>

      <label for="modalCategoria">Categoría</label>
      <select id="modalCategoria"></select>

      <div id="grupoSubcategoria" style="display:none;">
        <label for="modalSubcat">Subcategoría</label>
        <select id="modalSubcat"></select>
      </div>

      <label for="modalMonto">Monto</label>
      <input type="number" id="modalMonto" placeholder="0.00" />

      <label for="modalNota">Nota (opcional)</label>
      <textarea id="modalNota" placeholder="Ej. Detalle rápido..."></textarea>

      <div class="modal-actions">
        <button class="btn-cancel" id="btnCancel">Cancelar</button>
        <button class="btn-save" id="btnSave">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // DATOS DEMO (BASE MENSUAL)
    // -----------------------------
    const demoData = {
      tipo: "mensual",
      presupuesto: {
        ingresos: [
          { categoria: "Salario fijo", label: "Salario fijo", monto: 3200 },
          { categoria: "Ingreso extra", label: "Ingreso extra", monto: 500 },
          { categoria: "Intereses / dividendos", label: "Intereses / dividendos", monto: 150 }
        ],
        gastos: [
          { categoria: "Casa", label: "Casa – Hipoteca / alquiler", monto: 1200 },
          { categoria: "Alimentación", label: "Alimentación – Supermercado", monto: 500 },
          { categoria: "Alimentación", label: "Alimentación – Comidas fuera", monto: 150 },
          { categoria: "Transportación", label: "Transportación – Gasolina", monto: 150 },
          { categoria: "Deuda", label: "Deuda – Tarjetas de crédito", monto: 300 }
        ],
        ahorro: [
          { categoria: "Emergencia", label: "Emergencia – Fondo corto plazo", monto: 250 },
          { categoria: "Meta específica", label: "Meta específica – Vacaciones", monto: 200 }
        ]
      },
      real: {
        ingresos: [
          { categoria: "Salario fijo", monto: 3300 },
          { categoria: "Ingreso extra", monto: 450 },
          { categoria: "Intereses / dividendos", monto: 120 }
        ],
        gastos: [
          { categoria: "Casa", monto: 1250 },
          { categoria: "Alimentación", monto: 780 },
          { categoria: "Transportación", monto: 250 },
          { categoria: "Entretenimiento", monto: 190 },
          { categoria: "Deuda", monto: 360 }
        ],
        ahorro: [
          { categoria: "Emergencia", monto: 180 },
          { categoria: "Meta específica", monto: 150 }
        ]
      }
    };

    // CATEGORÍAS PRINCIPALES
    const opcionesCategorias = {
      ingresos: [
        "Salario fijo",
        "Pago por hora",
        "Bono",
        "Comisión",
        "Negocio propio",
        "Propina",
        "Ingresos pasivos",
        "Intereses / dividendos"
      ],
      gastos: [
        "Casa",
        "Alimentación",
        "Impuestos",
        "Transportación",
        "Seguros",
        "Regalos y donaciones",
        "Gastos Médicos",
        "Cuidado Personal",
        "Dependientes",
        "Deuda",
        "Entretenimiento",
        "Telecomunicaciones"
      ],
      ahorro: [
        "Emergencia",
        "Meta específica",
        "Inversión",
        "Retiro",
        "Ahorro personal",
        "Ahorro para hijos",
        "Otros"
      ]
    };

    // SUBCATEGORÍAS (simplificadas, alineadas con desktop)
    const subcategoriasPorArea = {
      ingresos: {
        "Salario fijo": ["Mensual", "Quincenal"],
        "Pago por hora": ["Horas regulares", "Horas extra"],
        "Bono": ["Bono anual", "Bono puntual"],
        "Comisión": ["Ventas", "Servicios"],
        "Negocio propio": ["Producto", "Servicio"],
        "Propina": ["Restaurante", "Otros"],
        "Ingresos pasivos": ["Renta inmueble", "Regalías"],
        "Intereses / dividendos": ["Cuenta inversión", "Cuenta ahorro"]
      },
      gastos: {
        "Casa": ["Hipoteca / alquiler", "Servicios", "Mantenimiento"],
        "Alimentación": ["Supermercado", "Comidas fuera", "Pedido a domicilio"],
        "Impuestos": ["Propiedad", "Estatales", "Federales", "Municipales"],
        "Transportación": ["Gasolina", "Mantenimiento", "Transporte público / Uber"],
        "Seguros": ["Salud", "Auto", "Vida"],
        "Regalos y donaciones": ["Familia", "Amigos", "Instituciones"],
        "Gastos Médicos": ["Consultas", "Medicamentos", "Procedimientos"],
        "Cuidado Personal": ["Peluquería", "Cosméticos", "Spa / Barbería"],
        "Dependientes": ["Cuidado de niños", "Cuidado de mayores", "Educación"],
        "Deuda": ["Tarjetas de crédito", "Préstamo estudiantil", "Otros préstamos"],
        "Entretenimiento": ["Cine / streaming", "Salidas", "Eventos"],
        "Telecomunicaciones": ["Teléfono", "Internet", "TV"]
      },
      ahorro: {
        "Emergencia": ["Fondo corto plazo", "Fondo largo plazo"],
        "Meta específica": ["Vacaciones", "Auto", "Casa", "Educación"],
        "Inversión": ["Fondos indexados", "Acciones", "Otros"],
        "Retiro": ["Plan empleador", "Cuenta individual"],
        "Ahorro personal": ["Ahorro mensual", "Efectivo"],
        "Ahorro para hijos": ["Educación", "Regalos futuros"],
        "Otros": ["Proyectos personales", "Donaciones planificadas"]
      }
    };

    let tipoActual = "mensual";        // mensual/anual
    let areaComparativa = "ingresos";  // ingresos/gastos/ahorro
    let chartComp = null;

    // Estado para modal (añadir / editar)
    let areaModal = "ingresos";
    let modoModal = "add"; // "add" o "edit"
    let indiceModal = null;

    function factorTipo() {
      return tipoActual === "anual" ? 12 : 1;
    }

    function formatear(monto) {
      return "$" + monto.toLocaleString("es-US", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    function sumarLista(lista) {
      const f = factorTipo();
      return lista.reduce((acc, item) => acc + item.monto * f, 0);
    }

    // Render de cada área agrupando por categoría (con regla 1-partida / varias)
    function renderArea(area, contId, resumenId) {
      const f = factorTipo();
      const cont = document.getElementById(contId);
      cont.innerHTML = "";

      const lista = demoData.presupuesto[area];

      // agrupar por categoría
      const grupos = {};
      lista.forEach((item, index) => {
        const cat = item.categoria;
        if (!grupos[cat]) {
          grupos[cat] = { total: 0, items: [] };
        }
        grupos[cat].total += item.monto * f;
        grupos[cat].items.push({ ...item, __index: index });
      });

      // render de grupos
      Object.keys(grupos).forEach(cat => {
        const grupo = grupos[cat];

        // SOLO UNA PARTIDA → fila simple (sin acordeón)
        if (grupo.items.length === 1) {
          const item = grupo.items[0];
          const row = document.createElement("div");
          row.className = "row";
          row.dataset.area = area;
          row.dataset.index = item.__index;

          const labelSpan = document.createElement("span");
          const label = item.label || item.categoria;
          labelSpan.textContent = label;

          const montoSpan = document.createElement("span");
          montoSpan.textContent = formatear(item.monto * f);

          row.appendChild(labelSpan);
          row.appendChild(montoSpan);

          row.addEventListener("click", () => {
            const idx = parseInt(row.dataset.index, 10);
            abrirModal(area, idx);
          });

          cont.appendChild(row);
          return;
        }

        // VARIAS PARTIDAS → acordeón
        const groupDiv = document.createElement("div");
        groupDiv.className = "cat-group collapsed";

        const header = document.createElement("div");
        header.className = "cat-group-header";

        const titleDiv = document.createElement("div");
        titleDiv.className = "cat-group-title";
        const nameSpan = document.createElement("span");
        nameSpan.className = "cat-group-name";
        nameSpan.textContent = cat;
        const summarySpan = document.createElement("span");
        summarySpan.className = "cat-group-summary";
        summarySpan.textContent = `${grupo.items.length} partida(s)`;

        titleDiv.appendChild(nameSpan);
        titleDiv.appendChild(summarySpan);

        const rightDiv = document.createElement("div");
        const totalSpan = document.createElement("span");
        totalSpan.className = "cat-group-total";
        totalSpan.textContent = formatear(grupo.total);
        const arrowSpan = document.createElement("span");
        arrowSpan.className = "cat-group-arrow";
        arrowSpan.textContent = "⌄";

        rightDiv.appendChild(totalSpan);
        rightDiv.appendChild(arrowSpan);

        header.appendChild(titleDiv);
        header.appendChild(rightDiv);

        const body = document.createElement("div");
        body.className = "cat-group-body";

        grupo.items.forEach(item => {
          const subRow = document.createElement("div");
          subRow.className = "cat-sub-row";
          subRow.dataset.area = area;
          subRow.dataset.index = item.__index;

          const labelSpan = document.createElement("span");
          // sólo subcategoría (sin repetir categoría)
          let subLabel = "";
          if (item.label) {
            const parts = item.label.split(" – ");
            subLabel = parts.length > 1 ? parts.slice(1).join(" – ") : item.label;
          } else {
            subLabel = item.categoria;
          }
          labelSpan.textContent = subLabel;

          const montoSpan = document.createElement("span");
          montoSpan.textContent = formatear(item.monto * f);

          subRow.appendChild(labelSpan);
          subRow.appendChild(montoSpan);

          subRow.addEventListener("click", (e) => {
            e.stopPropagation();
            const idx = parseInt(subRow.dataset.index, 10);
            abrirModal(area, idx);
          });

          body.appendChild(subRow);
        });

        header.addEventListener("click", () => {
          groupDiv.classList.toggle("collapsed");
        });

        groupDiv.appendChild(header);
        groupDiv.appendChild(body);
        cont.appendChild(groupDiv);
      });

      // resumen total por área
      const totalArea = sumarLista(lista);
      document.getElementById(resumenId).textContent = formatear(totalArea);
    }

    function renderSecciones() {
      renderArea("ingresos", "listaIngresos", "resumenIngresos");
      renderArea("gastos", "listaGastos", "resumenGastos");
      renderArea("ahorro", "listaAhorro", "resumenAhorro");
    }

    function renderTotales() {
      const tIng = sumarLista(demoData.presupuesto.ingresos);
      const tGas = sumarLista(demoData.presupuesto.gastos);
      const tAh = sumarLista(demoData.presupuesto.ahorro);
      const disp = tIng - tGas - tAh;

      document.getElementById("totalIngresos").textContent = formatear(tIng);
      document.getElementById("totalGastos").textContent = formatear(tGas);
      document.getElementById("totalAhorro").textContent = formatear(tAh);
      document.getElementById("totalDisponible").textContent = formatear(disp);
    }

    // Banner que depende del área (ingresos / gastos / ahorro)
    function actualizarBanner(pres, real, area) {
      const banner = document.getElementById("statusBanner");
      const pctSpan = document.getElementById("bannerPct");

      banner.classList.remove("green", "yellow", "red");

      if (!pres || pres === 0) {
        banner.classList.add("yellow");
        banner.innerHTML = `<span>Sin presupuesto en esta área.</span><span></span>`;
        return;
      }

      const diff = real - pres;     // signo importa
      const ratio = real / pres;
      const pct = Math.round(ratio * 100);
      pctSpan.textContent = pct + "%";

      // umbral para "muy cerca"
      const umbral = pres * 0.05;
      const dentroRango = Math.abs(diff) <= umbral;

      let texto = "";

      if (area === "ingresos") {
        if (diff > umbral) {
          banner.classList.add("green");
          texto = "<strong>Ingresos arriba.</strong> Ganaste más de lo planificado.";
        } else if (dentroRango) {
          banner.classList.add("yellow");
          texto = "<strong>Cerca de lo planificado.</strong>";
        } else {
          banner.classList.add("red");
          texto = "<strong>Ingresos abajo.</strong> Entró menos de lo esperado.";
        }
      } else if (area === "gastos") {
        if (diff < -umbral) {
          // gastó menos → positivo
          banner.classList.add("green");
          texto = "<strong>Vas bien.</strong> Gasto por debajo del presupuesto.";
        } else if (dentroRango) {
          banner.classList.add("yellow");
          texto = "<strong>Casi al límite.</strong> Muy cerca del presupuesto.";
        } else {
          // gastó más
          banner.classList.add("red");
          texto = "<strong>Te pasaste.</strong> Gasto por encima del presupuesto.";
        }
      } else if (area === "ahorro") {
        if (diff > umbral) {
          banner.classList.add("green");
          texto = "<strong>Buen trabajo.</strong> Ahorro por encima de lo planificado.";
        } else if (dentroRango) {
          banner.classList.add("yellow");
          texto = "<strong>Cerca de la meta.</strong>";
        } else {
          banner.classList.add("red");
          texto = "<strong>Ahorro bajo.</strong> Estás ahorrando menos de lo planeado.";
        }
      }

      // Mantener estructura del banner
      banner.innerHTML = `<span>${texto}</span><span id="bannerPct">${pct}%</span>`;
    }

    function renderTopDeviations() {
      const cont = document.getElementById("topDeviations");
      cont.innerHTML = "";

      if (areaComparativa !== "gastos") {
        cont.style.display = "none";
        return;
      }

      const f = factorTipo();
      cont.style.display = "block";

      const mapaPres = {};
      demoData.presupuesto.gastos.forEach(g => {
        mapaPres[g.categoria] = (mapaPres[g.categoria] || 0) + g.monto * f;
      });

      const mapaReal = {};
      demoData.real.gastos.forEach(g => {
        mapaReal[g.categoria] = (mapaReal[g.categoria] || 0) + g.monto * f;
      });

      const categorias = new Set([
        ...Object.keys(mapaPres),
        ...Object.keys(mapaReal)
      ]);

      const desviaciones = [];
      categorias.forEach(cat => {
        const pres = mapaPres[cat] || 0;
        const real = mapaReal[cat] || 0;
        const diff = real - pres;
        if (Math.abs(diff) > 0) {
          desviaciones.push({ cat, pres, real, diff });
        }
      });

      desviaciones.sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff));

      const top = desviaciones.slice(0, 3);

      if (top.length === 0) {
        cont.innerHTML = "<div class='top-dev-detail'>Sin desviaciones relevantes.</div>";
        return;
      }

      top.forEach(item => {
        const row = document.createElement("div");
        row.className = "top-dev-item";

        const left = document.createElement("div");
        left.className = "top-dev-left";
        left.innerHTML = `
          <span class="top-dev-name">${item.cat}</span>
          <span class="top-dev-detail">Pres: ${formatear(item.pres)} · Real: ${formatear(item.real)}</span>
        `;

        const diffSpan = document.createElement("span");
        diffSpan.className = "top-dev-diff " + (item.diff > 0 ? "positive" : "negative");
        const signo = item.diff > 0 ? "+" : "-";
        const montoAbs = Math.abs(item.diff);
        diffSpan.textContent = signo + formatear(montoAbs);

        row.appendChild(left);
        row.appendChild(diffSpan);
        cont.appendChild(row);
      });
    }

    function renderComparativo() {
      const f = factorTipo();

      const presLista = demoData.presupuesto[areaComparativa];
      const realLista = demoData.real[areaComparativa];

      const totalPres = sumarLista(presLista);
      const totalReal = realLista.reduce((acc, item) => acc + item.monto * f, 0);

      // diferencia “matemática” (real - presupuesto)
      const diffRaw = totalReal - totalPres;

      // diferencia “visual” según el área:
      // - ingresos / ahorro: real - pres (más es positivo)
      // - gastos: pres - real (menos gasto es positivo)
      let diffVisual = diffRaw;
      if (areaComparativa === "gastos") {
        diffVisual = totalPres - totalReal;
      }

      document.getElementById("miniPres").textContent = formatear(totalPres);
      document.getElementById("miniReal").textContent = formatear(totalReal);

      const diffSpan = document.getElementById("miniDiff");
      diffSpan.classList.remove("diff-positive", "diff-negative");

      if (diffVisual === 0) {
        diffSpan.textContent = formatear(0);
      } else {
        const signo = diffVisual > 0 ? "+" : "-";
        const montoAbs = Math.abs(diffVisual);
        diffSpan.textContent = signo + formatear(montoAbs);
        if (diffVisual > 0) {
          diffSpan.classList.add("diff-positive");
        } else {
          diffSpan.classList.add("diff-negative");
        }
      }

      actualizarBanner(totalPres, totalReal, areaComparativa);

      const ctx = document.getElementById("barComp").getContext("2d");
      if (chartComp) chartComp.destroy();

      chartComp = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Presupuesto", "Real"],
          datasets: [
            {
              label: areaComparativa.charAt(0).toUpperCase() + areaComparativa.slice(1),
              data: [totalPres, totalReal]
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });

      renderTopDeviations();
    }

    function configurarToggleTipo() {
      const toggle = document.getElementById("toggleTipo");
      const selectMonth = document.getElementById("selectMonth");

      toggle.querySelectorAll("span").forEach(span => {
        span.addEventListener("click", () => {
          const nuevo = span.getAttribute("data-tipo");
          if (nuevo === tipoActual) return;
          tipoActual = nuevo;

          toggle.querySelectorAll("span").forEach(s => s.classList.remove("active"));
          span.classList.add("active");

          // mostrar/ocultar mes
          if (tipoActual === "mensual") {
            selectMonth.style.display = "";
          } else {
            selectMonth.style.display = "none";
          }

          renderSecciones();
          renderTotales();
          renderComparativo();
        });
      });

      // estado inicial
      selectMonth.style.display = "";
    }

    function configurarChips() {
      const chips = document.getElementById("chipsArea");
      chips.querySelectorAll(".chip").forEach(chip => {
        chip.addEventListener("click", () => {
          const area = chip.getAttribute("data-area");
          if (area === areaComparativa) return;
          areaComparativa = area;

          chips.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
          chip.classList.add("active");

          renderComparativo();
        });
      });
    }

    function actualizarSubcategoriasModal() {
      const selCat = document.getElementById("modalCategoria");
      const subWrap = document.getElementById("grupoSubcategoria");
      const selSub = document.getElementById("modalSubcat");

      const mapaArea = subcategoriasPorArea[areaModal] || {};
      const lista = mapaArea[selCat.value] || [];

      if (!lista || lista.length === 0) {
        subWrap.style.display = "none";
        selSub.innerHTML = "";
        return;
      }

      subWrap.style.display = "block";
      selSub.innerHTML = "";
      const optBlank = document.createElement("option");
      optBlank.value = "";
      optBlank.textContent = "Selecciona subcategoría";
      selSub.appendChild(optBlank);

      lista.forEach(sub => {
        const opt = document.createElement("option");
        opt.value = sub;
        opt.textContent = sub;
        selSub.appendChild(opt);
      });
    }

    function abrirModal(area, index = null) {
      areaModal = area;
      modoModal = index === null ? "add" : "edit";
      indiceModal = index;

      const modal = document.getElementById("modal");
      const title = document.getElementById("modalTitle");
      const selCat = document.getElementById("modalCategoria");
      const selSub = document.getElementById("modalSubcat");
      const montoInput = document.getElementById("modalMonto");
      const nota = document.getElementById("modalNota");

      title.textContent = (modoModal === "add" ? "Añadir a " : "Editar en ") + areaModal;

      // llenar categorías
      selCat.innerHTML = "";
      opcionesCategorias[areaModal].forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        selCat.appendChild(opt);
      });

      // estado por defecto
      montoInput.value = "";
      nota.value = "";
      selSub.innerHTML = "";
      document.getElementById("grupoSubcategoria").style.display = "none";

      if (modoModal === "edit" && demoData.presupuesto[areaModal][index]) {
        const item = demoData.presupuesto[areaModal][index];
        selCat.value = item.categoria;

        const f = factorTipo();
        montoInput.value = (item.monto * f).toFixed(2);

        actualizarSubcategoriasModal();
        const label = item.label || item.categoria;
        const parts = label.split(" – ");
        if (parts.length > 1) {
          const sub = parts.slice(1).join(" – ");
          const selSubEl = document.getElementById("modalSubcat");
          Array.from(selSubEl.options).forEach(o => {
            if (o.value === sub) selSubEl.value = sub;
          });
        }
      } else {
        actualizarSubcategoriasModal();
      }

      modal.classList.add("open");
    }

    function cerrarModal() {
      document.getElementById("modal").classList.remove("open");
    }

    function configurarModal() {
      document.querySelectorAll(".add-btn-small").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const area = btn.getAttribute("data-area");
          abrirModal(area, null);
        });
      });

      document.getElementById("btnCancel").addEventListener("click", cerrarModal);

      document.getElementById("modalCategoria").addEventListener("change", () => {
        actualizarSubcategoriasModal();
      });

      document.getElementById("btnSave").addEventListener("click", () => {
        const selCat = document.getElementById("modalCategoria");
        const selSub = document.getElementById("modalSubcat");
        const montoInput = document.getElementById("modalMonto");

        const valor = parseFloat(montoInput.value || "0");
        if (!valor) {
          cerrarModal();
          return;
        }

        const f = factorTipo();
        const categoria = selCat.value;
        const subcat = selSub.value || "";
        const label = subcat ? `${categoria} – ${subcat}` : categoria;

        const montoMensual = valor / f; // siempre guardamos en base mensual

        const lista = demoData.presupuesto[areaModal];

        if (modoModal === "edit" && indiceModal !== null && lista[indiceModal]) {
          lista[indiceModal].categoria = categoria;
          lista[indiceModal].label = label;
          lista[indiceModal].monto = montoMensual;
        } else {
          lista.push({
            categoria,
            label,
            monto: montoMensual
          });
        }

        cerrarModal();
        renderSecciones();
        renderTotales();
        renderComparativo();
      });

      document.getElementById("modal").addEventListener("click", (e) => {
        if (e.target.id === "modal") cerrarModal();
      });
    }

    function configurarAcordeones() {
      document.querySelectorAll(".accordion-header").forEach(header => {
        header.addEventListener("click", () => {
          const section = header.closest(".section");
          section.classList.toggle("collapsed");
        });
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      configurarToggleTipo();
      configurarChips();
      configurarModal();
      configurarAcordeones();
      renderSecciones();
      renderTotales();
      renderComparativo();
    });
  </script>
</body>
</html>
