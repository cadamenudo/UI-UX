<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Presupuesto mÃ³vil â€“ Cada Menudo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <!-- Nunito -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800;900&display=swap" rel="stylesheet"/>

  <style>
  :root{
    --primary:#3956E8;
    --secondary:#7459D9;
    --bg:#F6F7FF;
    --card:#FFFFFF;
    --text:#0f172a;
    --muted:#64748B;
    --border:#E5E7EB;
    --shadow:0 4px 12px rgba(0,0,0,0.06);
    --radius:16px;
    --tap:48px;
    --success:#22C55E;
    --warning:#F59E0B;
    --danger:#EF4444;
  }

  *{box-sizing:border-box}
  body{
    font-family: Nunito, sans-serif;
    background: var(--bg);
    padding: 0;
    margin: 0;
    color: var(--text);
    -webkit-tap-highlight-color: transparent;
    overflow-x: hidden;
  }

  /* Sticky header */
  .sticky-wrap{
    position: sticky;
    top: 0;
    z-index: 50;
    background: var(--bg);
    padding: 14px 16px 10px;
    border-bottom: 1px solid rgba(229,231,235,.75);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }

  .top{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom: 10px;
  }

  h1{
    font-size: 1.25rem;
    font-weight: 900;
    margin: 0;
    letter-spacing: -0.4px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .toggle{
    background: white;
    border-radius: 999px;
    padding: 4px;
    display: flex;
    gap: 4px;
    border: 1px solid var(--border);
    flex-shrink:0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }
  .toggle span{
    padding: 8px 14px;
    border-radius: 999px;
    cursor: pointer;
    font-size: 0.85rem;
    min-height: 36px;
    display:flex;align-items:center;justify-content:center;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: 700;
  }
  .toggle .active{
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    font-weight: 900;
    transform: scale(1.02);
    box-shadow: 0 2px 8px rgba(57,86,232,0.3);
  }

  .select-month{
    background: white;
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid var(--border);
    font-size: 0.92rem;
    width: 100%;
    outline: none;
    font-weight: 700;
    box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    transition: all 0.2s ease;
  }
  .select-month:focus{
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(57,86,232,0.1);
  }

  /* Main content padding */
  .page{
    padding: 14px 16px 110px;
  }

  /* Sections */
  .section{
    background: var(--card);
    padding: 12px 16px;
    border-radius: 16px;
    margin-bottom: 12px;
    box-shadow: var(--shadow);
    border: 1px solid rgba(229,231,235,0.6);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .section.ingresos{ border-left: 4px solid var(--success); }
  .section.gastos  { border-left: 4px solid #F97316; }
  .section.ahorro  { border-left: 4px solid #3B82F6; }

  .section-header-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    cursor:pointer;
    padding: 8px 0;
    min-height: var(--tap);
    transition: opacity 0.2s ease;
  }
  .section-header-row:active{
    opacity: 0.7;
  }
  .section-header{
    font-weight: 900;
    font-size: 1.05rem;
    letter-spacing: -0.3px;
  }
  .section-label{
    font-size: 0.78rem;
    color: var(--muted);
    margin-top: 3px;
    font-weight: 600;
  }
  .accordion-right{
    display:flex;
    align-items:center;
    gap:10px;
  }

  .btn-add-section {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    font-size: 1.3rem;
    font-weight: 900;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(57, 86, 232, 0.3);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    flex-shrink: 0;
  }

  .btn-add-section:active {
    transform: scale(0.92);
  }

  .accordion-icon{
    font-size: 1rem;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: bold;
  }
  .section.collapsed .accordion-icon{ transform: rotate(-90deg); }
  .section-body{ 
    margin-top: 8px;
    max-height: 2000px;
    overflow: hidden;
    transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
    opacity: 1;
  }
  .section.collapsed .section-body{ 
    max-height: 0;
    opacity: 0;
  }

  /* Nueva fila de input inline */
  .input-row {
    background: linear-gradient(135deg, #F0F9FF, #E0F2FE);
    border: 2px solid var(--primary);
    border-radius: 14px;
    padding: 12px 14px;
    margin-bottom: 12px;
    animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .input-row-label {
    font-weight: 900;
    font-size: 0.95rem;
    color: var(--text);
    margin-bottom: 8px;
  }

  .input-row-field {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-bottom: 10px;
  }

  .input-row-monto {
    flex: 1;
    padding: 12px 14px;
    border: 1.5px solid #D1D5DB;
    border-radius: 12px;
    font-size: 1.1rem;
    font-weight: 700;
    font-family: inherit;
    outline: none;
    transition: all 0.2s ease;
  }

  .input-row-monto:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(57, 86, 232, 0.1);
  }

  .input-row-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }

  .input-row-btn {
    padding: 10px 20px;
    border: none;
    border-radius: 10px;
    font-weight: 900;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .input-row-btn.cancelar {
    background: #F3F4F6;
    color: var(--text);
  }

  .input-row-btn.guardar {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    box-shadow: 0 4px 12px rgba(57, 86, 232, 0.3);
  }

  .input-row-btn:active {
    transform: scale(0.97);
  }

  /* Swipeable rows */
  .row-wrapper{
    position: relative;
    margin-bottom: 6px;
    border-radius: 12px;
    overflow: hidden;
  }
  
  .row-delete-bg{
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 80px;
    background: linear-gradient(90deg, transparent, var(--danger));
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 20px;
    color: white;
    font-weight: 900;
    font-size: 0.85rem;
  }

  .row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding: 12px 10px;
    font-size: 0.95rem;
    border-radius: 12px;
    min-height: var(--tap);
    background: white;
    position: relative;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), background 0.2s ease;
    cursor: pointer;
    touch-action: pan-y;
  }
  .row:active{ background: #F9FAFB; }
  .row span:first-child{ font-weight: 600; }
  .row span:last-child{ font-weight: 900; }

  /* Progress bars */
  .progress-wrapper{
    margin-top: 6px;
    margin-bottom: 2px;
  }
  .progress-bar{
    height: 4px;
    background: #E5E7EB;
    border-radius: 999px;
    overflow: hidden;
    position: relative;
  }
  .progress-fill{
    height: 100%;
    border-radius: 999px;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s ease;
    background: linear-gradient(90deg, var(--success), #22C55E);
  }
  .progress-fill.warning{
    background: linear-gradient(90deg, var(--warning), #FBBF24);
  }
  .progress-fill.danger{
    background: linear-gradient(90deg, var(--danger), #F87171);
  }
  .progress-label{
    font-size: 0.7rem;
    color: var(--muted);
    margin-top: 2px;
    font-weight: 700;
  }

  /* Category groups */
  .cat-group{
    background:#F9FAFB;
    border-radius: 14px;
    padding: 8px 10px;
    margin-bottom: 8px;
    border: 1px solid rgba(229,231,235,.65);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .cat-group-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    cursor:pointer;
    padding: 8px 6px;
    min-height: var(--tap);
    transition: opacity 0.2s ease;
  }
  .cat-group-header:active{
    opacity: 0.7;
  }
  .cat-group-name{ font-size: 0.95rem; font-weight: 900; }
  .cat-group-summary{ font-size: 0.78rem; color: var(--muted); font-weight: 700; margin-top: 2px; }
  .cat-group-total{ font-weight: 900; font-size: 0.95rem; }
  .cat-group-arrow{ font-size: .9rem; margin-left: 8px; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
  .cat-group.collapsed .cat-group-body{ 
    max-height: 0;
    opacity: 0;
  }
  .cat-group.collapsed .cat-group-arrow{ transform: rotate(-90deg); }

  .cat-group-body{
    margin-top: 4px;
    padding-top: 4px;
    border-top: 1px dashed #E5E7EB;
    max-height: 2000px;
    overflow: hidden;
    transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
    opacity: 1;
  }
  .cat-sub-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding: 12px 8px;
    font-size: 0.88rem;
    border-radius: 12px;
    min-height: var(--tap);
    cursor:pointer;
    transition: background 0.2s ease;
  }
  .cat-sub-row:active{ background: rgba(57,86,232,0.08); }
  .cat-sub-row span:first-child{ font-weight: 600; }
  .cat-sub-row span:last-child{ font-weight: 900; }

  /* Totals collapsible */
  .totals{
    margin-top: 10px;
    margin-bottom: 14px;
    background: linear-gradient(135deg, #E8ECFF, #DDD6FE);
    padding: 14px 16px;
    border-radius: 16px;
    border: 1px solid #C7D2FE;
    box-shadow: 0 4px 12px rgba(116,89,217,0.12);
  }
  .totals-top{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
    cursor:pointer;
    min-height: var(--tap);
    transition: opacity 0.2s ease;
  }
  .totals-top:active{
    opacity: 0.7;
  }
  .totals-title{
    font-weight: 900;
    color: #1f2a5a;
    font-size: 1rem;
  }
  .totals-chevron{
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: 900;
  }
  .totals.collapsed .totals-chevron{ transform: rotate(-90deg); }
  .totals-body{ 
    margin-top: 8px;
    max-height: 1000px;
    overflow: hidden;
    transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
    opacity: 1;
  }
  .totals.collapsed .totals-body{ 
    max-height: 0;
    opacity: 0;
  }
  .totals .row{
    padding: 10px 0;
    min-height: auto;
    background: transparent;
  }
  .totals .row span:first-child{ color: #4B5563; font-weight: 800; }
  .totals .row span:last-child{ color: #111827; font-weight: 900; }

  /* Save button */
  .save{
    margin-top: 12px;
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, var(--secondary), var(--primary));
    color: white;
    border-radius: 16px;
    font-size: 1.05rem;
    font-weight: 900;
    border: none;
    cursor: pointer;
    min-height: 56px;
    box-shadow: 0 10px 25px rgba(116,89,217,.25);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .save:active{
    transform: scale(0.98);
    box-shadow: 0 5px 15px rgba(116,89,217,.3);
  }

  /* Card base */
  .card{
    background: white;
    padding: 16px;
    border-radius: 16px;
    box-shadow: var(--shadow);
    margin-bottom: 14px;
    border: 1px solid rgba(229,231,235,0.6);
  }
  .card.comp-card{ margin-top: 14px; }

  .comp-header{
    margin-bottom: 12px;
  }
  .comp-title{ font-weight: 900; font-size: 1.05rem; letter-spacing: -0.3px; }
  .chips{ 
    display:flex; 
    gap: 8px; 
    flex-wrap: wrap; 
    justify-content: center;
    margin-bottom: 14px;
  }
  .chip{
    border-radius: 999px;
    border: 1px solid var(--border);
    padding: 8px 12px;
    font-size: 0.8rem;
    cursor: pointer;
    background: #FFFFFF;
    color: var(--muted);
    min-height: 38px;
    font-weight: 800;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .chip:active{
    transform: scale(0.95);
  }
  .chip.active{
    border-color: var(--primary);
    background: linear-gradient(135deg, #E8ECFF, #DDD6FE);
    color: var(--primary);
    box-shadow: 0 2px 8px rgba(57,86,232,0.15);
  }

  /* Status banner */
  .status-banner{
    border-radius: 14px;
    padding: 12px 12px;
    font-size: 0.88rem;
    margin-bottom: 12px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    border: 1px solid;
  }
  .status-banner.green{ background:#ECFDF3; color:#15803D; border-color: rgba(21,128,61,0.2); }
  .status-banner.yellow{ background:#FEF9C3; color:#92400E; border-color: rgba(146,64,14,0.2); }
  .status-banner.red{ background:#FEF2F2; color:#B91C1C; border-color: rgba(185,28,28,0.2); }
  .status-banner strong{ font-weight: 900; }

  .mini-summary .row{ font-size: 0.92rem; padding: 10px 0; min-height:auto; }
  .mini-summary .row span:first-child{ color: var(--muted); font-weight: 800; }

  #miniDiff.diff-positive{ color:#15803D; font-weight: 900; }
  #miniDiff.diff-negative{ color:#B91C1C; font-weight: 900; }

  /* Bullet Chart */
  .bullet-chart {
    margin: 1.2rem 0;
  }

  .bullet-chart-label {
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--muted);
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .bullet-chart-bar {
    position: relative;
    height: 40px;
    background: #F3F4F6;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 1rem;
  }

  .bullet-budget {
    position: absolute;
    height: 100%;
    background: linear-gradient(90deg, #E0E7FF, #C7D2FE);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 12px;
    font-weight: 900;
    font-size: 0.85rem;
    color: var(--primary);
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .bullet-actual {
    position: absolute;
    height: 24px;
    top: 8px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(57, 86, 232, 0.3);
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 10px;
    font-weight: 900;
    font-size: 0.85rem;
    color: white;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .bullet-actual.over-budget {
    background: linear-gradient(135deg, var(--danger), #F87171);
  }

  .bullet-actual.under-budget {
    background: linear-gradient(135deg, var(--success), #22C55E);
  }

  .bullet-legend {
    display: flex;
    gap: 1rem;
    justify-content: center;
    font-size: 0.8rem;
    margin-top: 0.5rem;
  }

  .bullet-legend-item {
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .bullet-legend-color {
    width: 20px;
    height: 12px;
    border-radius: 4px;
  }

  .bullet-legend-color.budget {
    background: linear-gradient(90deg, #E0E7FF, #C7D2FE);
  }

  .bullet-legend-color.actual {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
  }

  canvas{ max-height: 260px; display:block; margin: 0 auto; }

  .top-deviations{
    border-top: 1px dashed #E5E7EB;
    padding-top: 8px;
    margin-top: 6px;
    font-size: 0.85rem;
  }
  .top-dev-item{
    display:flex;
    justify-content:space-between;
    padding: 10px 0;
    gap: 10px;
  }
  .top-dev-name{ font-weight: 900; }
  .top-dev-detail{ color: var(--muted); font-size: .78rem; font-weight: 700; margin-top: 2px; }
  .top-dev-diff.positive{ color:#B91C1C; font-weight: 900; }
  .top-dev-diff.negative{ color:#15803D; font-weight: 900; }

  /* Modal CategorÃ­as */
  .modal-categorias {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.6);
    display: none;
    align-items: flex-end;
    justify-content: center;
    z-index: 999;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
  }

  .modal-categorias.open {
    display: flex;
    animation: fadeIn 0.2s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .modal-categorias-content {
    background: #fff;
    border-radius: 24px 24px 0 0;
    padding: 1.5rem 0 0;
    width: 100%;
    max-width: 100%;
    box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.2);
    max-height: 85vh;
    overflow-y: auto;
    animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
  }

  .modal-cat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 1.3rem 1rem;
    border-bottom: 1px solid #E5E7EB;
  }

  .modal-cat-title {
    font-size: 1.2rem;
    font-weight: 900;
    color: var(--text);
    letter-spacing: -0.3px;
  }

  .btn-cerrar-cat {
    background: none;
    border: none;
    font-size: 1.8rem;
    color: var(--muted);
    cursor: pointer;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
  }

  .btn-cerrar-cat:active {
    background: #F3F4F6;
  }

  .bloque-sector-modal {
    border-bottom: 1px solid #F3F4F6;
  }

  .encabezado-modal {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.3rem;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .encabezado-modal:active {
    background: #F9FAFB;
  }

  .encabezado-left-modal {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .encabezado-title-modal {
    font-size: 1.1rem;
    font-weight: 900;
    letter-spacing: -0.3px;
  }

  .icono-sector-modal {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    background-size: 30px;
    background-repeat: no-repeat;
    background-position: center;
    flex-shrink: 0;
  }

  .icono-ingresos-modal {
    background-color: #ECFDF3;
    background-image: url('https://cadamenudo.github.io/UI-UX/assets/icons/ingreso.png');
  }

  .icono-gastos-modal {
    background-color: #FEF2F2;
    background-image: url('https://cadamenudo.github.io/UI-UX/assets/icons/gastos.png');
  }

  .icono-ahorro-modal {
    background-color: #FEF9C3;
    background-image: url('https://cadamenudo.github.io/UI-UX/assets/icons/ahorro.png');
  }

  .chevron-modal {
    font-size: 1.1rem;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    color: var(--muted);
    font-weight: 900;
  }

  .bloque-sector-modal.abierto .chevron-modal {
    transform: rotate(180deg);
  }

  .contenido-bloque-modal {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .bloque-sector-modal.abierto .contenido-bloque-modal {
    max-height: 2000px;
  }

  .contenido-inner-modal {
    padding: 0 1.3rem 1rem;
  }

  .bloque-categoria-modal {
    background: #F9FAFB;
    border-radius: 14px;
    padding: 1rem 1.1rem;
    margin-bottom: 0.8rem;
    border: 1px solid rgba(229, 231, 235, 0.7);
  }

  .titulo-categoria-modal {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    padding: 0.3rem 0;
    transition: opacity 0.2s ease;
  }

  .titulo-categoria-modal:active {
    opacity: 0.7;
  }

  .titulo-cat-nombre-modal {
    font-weight: 900;
    font-size: 1rem;
    color: var(--text);
  }

  .subcategorias-modal {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    margin-top: 0;
  }

  .subcategorias-modal.activo {
    max-height: 1500px;
    margin-top: 0.8rem;
  }

  .fila-sub-modal {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.9rem 0.8rem;
    border-radius: 10px;
    margin-bottom: 0.4rem;
    background: white;
    transition: background 0.2s ease;
    cursor: pointer;
  }

  .fila-sub-modal:active {
    background: rgba(57,86,232,0.08);
  }

  .fila-sub-nombre-modal {
    font-weight: 600;
    font-size: 0.92rem;
    color: var(--text);
  }

  /* Delete confirmation */
  .delete-confirm{
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    padding: 20px;
    border-radius: 24px 24px 0 0;
    box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
    z-index: 1000;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .delete-confirm.show{
    transform: translateY(0);
  }
  .delete-confirm-text{
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 16px;
    color: #111827;
  }
  .delete-confirm-actions{
    display: flex;
    gap: 10px;
  }
  .delete-confirm-actions button{
    flex: 1;
    padding: 14px;
    border: none;
    border-radius: 14px;
    font-weight: 900;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .btn-delete-cancel{
    background: #F3F4F6;
    color: #111827;
  }
  .btn-delete-confirm{
    background: var(--danger);
    color: white;
  }
  .delete-confirm-actions button:active{
    transform: scale(0.98);
  }

  /* Toast */
  .toast{
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: 30px;
    background: rgba(15,23,42,.95);
    color: #fff;
    padding: 12px 16px;
    border-radius: 999px;
    font-weight: 900;
    font-size: .9rem;
    display:none;
    z-index: 1100;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  .toast.show{ 
    display:block;
    animation: toastIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  @keyframes toastIn {
    from { 
      opacity: 0;
      transform: translateX(-50%) translateY(20px);
    }
    to { 
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }

  /* Loading state */
  .loading-overlay{
    position: fixed;
    inset: 0;
    background: rgba(255,255,255,0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
  }
  .loading-overlay.show{
    display: flex;
  }
  .spinner{
    width: 50px;
    height: 50px;
    border: 4px solid rgba(57,86,232,0.2);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  </style>
</head>

<body>
  <!-- STICKY HEADER -->
  <div class="sticky-wrap">
    <div class="top">
      <h1>Presupuesto</h1>
      <div class="toggle" id="toggleTipo">
        <span data-tipo="mensual" class="active">Mensual</span>
        <span data-tipo="anual">Anual</span>
      </div>
    </div>

    <select class="select-month" id="selectMonth">
      <option>Enero 2025</option>
      <option>Febrero 2025</option>
      <option>Marzo 2025</option>
    </select>
  </div>

  <main class="page">

    <!-- SECCION INGRESOS -->
    <section class="section ingresos collapsed">
      <div class="section-header-row accordion-header" data-area="ingresos">
        <div>
          <div class="section-header">Ingresos</div>
          <div class="section-label">Lo que entra en el periodo</div>
        </div>
        <div class="accordion-right">
          <button class="btn-add-section" onclick="abrirModalCategorias(event, 'ingresos')">+</button>
          <span class="accordion-icon">âŒ„</span>
        </div>
      </div>
      <div class="section-body">
        <div id="listaIngresos"></div>
      </div>
    </section>

    <!-- SECCION GASTOS -->
    <section class="section gastos collapsed">
      <div class="section-header-row accordion-header" data-area="gastos">
        <div>
          <div class="section-header">Gastos</div>
          <div class="section-label">Lo que sale en el periodo</div>
        </div>
        <div class="accordion-right">
          <button class="btn-add-section" onclick="abrirModalCategorias(event, 'gastos')">+</button>
          <span class="accordion-icon">âŒ„</span>
        </div>
      </div>
      <div class="section-body">
        <div id="listaGastos"></div>
      </div>
    </section>

    <!-- SECCION AHORRO -->
    <section class="section ahorro collapsed">
      <div class="section-header-row accordion-header" data-area="ahorro">
        <div>
          <div class="section-header">Ahorro</div>
          <div class="section-label">Lo que apartas del ingreso</div>
        </div>
        <div class="accordion-right">
          <button class="btn-add-section" onclick="abrirModalCategorias(event, 'ahorro')">+</button>
          <span class="accordion-icon">âŒ„</span>
        </div>
      </div>
      <div class="section-body">
        <div id="listaAhorro"></div>
      </div>
    </section>

    <!-- TOTALES (COLLAPSIBLE) -->
    <section class="totals" id="totalsCard">
      <div class="totals-top" id="totalsToggle">
        <div class="totals-title">Totales del periodo</div>
        <div class="totals-chevron">âŒ„</div>
      </div>
      <div class="totals-body" id="totalsBody">
        <div class="row">
          <span>Total ingresos</span>
          <span id="totalIngresos">$0.00</span>
        </div>
        <div class="row">
          <span>Total gastos</span>
          <span id="totalGastos">$0.00</span>
        </div>
        <div class="row">
          <span>Total ahorro</span>
          <span id="totalAhorro">$0.00</span>
        </div>
        <div class="row">
          <span>Disponible</span>
          <span id="totalDisponible">$0.00</span>
        </div>
      </div>
    </section>

    <button class="save" id="btnGuardar">ðŸ’¾ Guardar presupuesto</button>

    <!-- COMPARATIVO -->
    <section class="card comp-card">
      <div class="comp-header">
        <div class="comp-title">Presupuesto vs Real</div>
      </div>
      
      <div class="chips" id="chipsArea">
        <button class="chip active" data-area="ingresos">Ingresos</button>
        <button class="chip" data-area="gastos">Gastos</button>
        <button class="chip" data-area="ahorro">Ahorro</button>
      </div>

      <div id="statusBanner" class="status-banner green">
        <span><strong>Vas bien.</strong> Por debajo del presupuesto.</span>
        <span id="bannerPct">90%</span>
      </div>

      <div class="mini-summary">
        <div class="row">
          <span>Presupuesto</span>
          <span id="miniPres">$0.00</span>
        </div>
        <div class="row">
          <span>Real</span>
          <span id="miniReal">$0.00</span>
        </div>
        <div class="row">
          <span>Diferencia</span>
          <span id="miniDiff">$0.00</span>
        </div>
      </div>

      <div class="bullet-chart" id="bulletChart">
        <div class="bullet-chart-label">
          <span>Comparativa</span>
        </div>
        <div class="bullet-chart-bar">
          <div class="bullet-budget" id="bulletBudget">
            <span id="bulletBudgetText">$0</span>
          </div>
          <div class="bullet-actual" id="bulletActual">
            <span id="bulletActualText">$0</span>
          </div>
        </div>
        <div class="bullet-legend">
          <div class="bullet-legend-item">
            <div class="bullet-legend-color budget"></div>
            <span>Presupuesto</span>
          </div>
          <div class="bullet-legend-item">
            <div class="bullet-legend-color actual"></div>
            <span>Real</span>
          </div>
        </div>
      </div>

      <div class="top-deviations" id="topDeviations"></div>
    </section>
  </main>

  <!-- Toast -->
  <div class="toast" id="toast">Guardado âœ…</div>

  <!-- Loading overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <!-- Delete confirmation -->
  <div class="delete-confirm" id="deleteConfirm">
    <div class="delete-confirm-text">Â¿Eliminar este elemento?</div>
    <div class="delete-confirm-actions">
      <button class="btn-delete-cancel" id="btnDeleteCancel">Cancelar</button>
      <button class="btn-delete-confirm" id="btnDeleteConfirm">Eliminar</button>
    </div>
  </div>

  <!-- MODAL CATEGORÃAS -->
  <div class="modal-categorias" id="modalCategorias">
    <div class="modal-categorias-content">
      <div class="modal-cat-header">
        <span class="modal-cat-title">Selecciona una categorÃ­a</span>
        <button class="btn-cerrar-cat" onclick="cerrarModalCategorias()">Ã—</button>
      </div>

      <!-- INGRESOS -->
      <div class="bloque-sector-modal">
        <div class="encabezado-modal" onclick="toggleBloqueModal(this)">
          <div class="encabezado-left-modal">
            <div class="icono-sector-modal icono-ingresos-modal"></div>
            <span class="encabezado-title-modal">Ingresos</span>
          </div>
          <span class="chevron-modal">âŒ„</span>
        </div>
        <div class="contenido-bloque-modal">
          <div class="contenido-inner-modal" id="contenedorIngresosModal"></div>
        </div>
      </div>

      <!-- GASTOS -->
      <div class="bloque-sector-modal">
        <div class="encabezado-modal" onclick="toggleBloqueModal(this)">
          <div class="encabezado-left-modal">
            <div class="icono-sector-modal icono-gastos-modal"></div>
            <span class="encabezado-title-modal">Gastos</span>
          </div>
          <span class="chevron-modal">âŒ„</span>
        </div>
        <div class="contenido-bloque-modal">
          <div class="contenido-inner-modal" id="contenedorGastosModal"></div>
        </div>
      </div>

      <!-- AHORRO -->
      <div class="bloque-sector-modal">
        <div class="encabezado-modal" onclick="toggleBloqueModal(this)">
          <div class="encabezado-left-modal">
            <div class="icono-sector-modal icono-ahorro-modal"></div>
            <span class="encabezado-title-modal">Ahorro</span>
          </div>
          <span class="chevron-modal">âŒ„</span>
        </div>
        <div class="contenido-bloque-modal">
          <div class="contenido-inner-modal" id="contenedorAhorroModal"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Datos de categorÃ­as
    const categorias = {
      ingresos: {
        'Pago por trabajo': ['Salario', 'Pago por hora', 'Bono', 'ComisiÃ³n', 'Negocio propio', 'Propina'],
        'Ganancia de capital': ['Acciones', 'Auto', 'Bonos o renta fija', 'Casa/Apartamento/Tierra', 'ETF, fondo mutuo, etc.'],
        'Ingreso pasivo': ['Anualidad', 'Dividendos e Intereses', 'PensiÃ³n', 'Renta inmueble', 'Seguro Social']
      },
      gastos: {
        'AlimentaciÃ³n': ['Supermercado', 'Comidas fuera', 'Pedido a domicilio'],
        'Casa': ['Hipoteca / Alquiler', 'Servicios bÃ¡sicos', 'Mantenimiento'],
        'Impuestos': ['Seguro social', 'Propiedad', 'Venta', 'Estatales', 'Federales', 'Municipales'],
        'TransportaciÃ³n': ['Gasolina', 'Mantenimiento', 'Transporte pÃºblico / Uber'],
        'Seguros': ['Salud', 'Auto', 'Vida'],
        'Regalos y donaciones': ['Familia', 'Amigos', 'Instituciones'],
        'Gastos MÃ©dicos': ['Consultas', 'Medicamentos', 'Procedimientos'],
        'Cuidado Personal': ['PeluquerÃ­a', 'CosmÃ©ticos', 'Spa / BarberÃ­a'],
        'Dependientes': ['Cuidado de niÃ±os', 'Cuidado de mayores', 'EducaciÃ³n'],
        'Deuda': ['Tarjetas de crÃ©dito', 'PrÃ©stamos estudiantiles', 'Otros prÃ©stamos'],
        'Entretenimiento': ['Cine', 'Conciertos', 'Streaming'],
        'Telecomunicaciones': ['TelÃ©fono', 'Internet', 'TV']
      },
      ahorro: {
        'Emergencia': ['Fondo corto plazo', 'Fondo largo plazo', 'Reserva mÃ©dica'],
        'Meta especÃ­fica': ['Vacaciones', 'Auto', 'Casa', 'Boda', 'EducaciÃ³n de hijos'],
        'InversiÃ³n': ['Cuenta brokerage', 'Fondo indexado', 'Cripto', 'Crowdfunding'],
        'Retiro': ['IRA / Roth IRA', '401(k)', 'PensiÃ³n privada'],
        'Ahorro personal': ['Ahorro mensual', 'Ahorro en efectivo', 'Cuenta de ahorro tradicional'],
        'Ahorro para hijos': ['EducaciÃ³n', 'Regalos futuros', 'Fondo universitario'],
        'Otros': ['Donaciones planificadas', 'Proyectos personales', 'Fondo de libertad financiera']
      }
    };

    // -----------------------------
    // DATOS (BASE MENSUAL) - VACÃO
    // -----------------------------
    const demoData = {
      tipo: "mensual",
      presupuesto: {
        ingresos: [],
        gastos: [],
        ahorro: []
      },
      real: {
        ingresos: [],
        gastos: [],
        ahorro: []
      }
    };

    let tipoActual = "mensual";
    let areaComparativa = "ingresos";

    let categoriaSeleccionada = null;
    let subcategoriaSeleccionada = null;
    let areaSeleccionada = null;

    let deleteTarget = null;

    function factorTipo(){ return tipoActual === "anual" ? 12 : 1; }

    function formatear(monto){
      return "$" + monto.toLocaleString("es-US",{minimumFractionDigits:2,maximumFractionDigits:2});
    }

    function sumarLista(lista){
      const f = factorTipo();
      return lista.reduce((acc, item) => acc + item.monto * f, 0);
    }

    function getProgressColor(pct, isExpense = false){
      if (isExpense){
        if (pct <= 75) return '';
        if (pct <= 90) return 'warning';
        return 'danger';
      } else {
        if (pct >= 90) return '';
        if (pct >= 70) return 'warning';
        return 'danger';
      }
    }

    function enableSwipe(element, onDelete){
      let startX = 0;
      let currentX = 0;
      let isDragging = false;

      element.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        isDragging = true;
      });

      element.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        currentX = e.touches[0].clientX;
        const diff = startX - currentX;
        
        if (diff > 0 && diff < 100) {
          element.style.transform = `translateX(-${diff}px)`;
        }
      });

      element.addEventListener('touchend', () => {
        if (!isDragging) return;
        isDragging = false;
        
        const diff = startX - currentX;
        if (diff > 80) {
          onDelete();
        }
        
        element.style.transform = '';
      });
    }

    function renderArea(area, contId){
      const f = factorTipo();
      const cont = document.getElementById(contId);
      
      // Remover solo los elementos que no son input-row
      const existingInputRow = cont.querySelector('.input-row');
      cont.innerHTML = "";
      
      // Si habÃ­a un input-row, volver a agregarlo al inicio
      if (existingInputRow) {
        cont.appendChild(existingInputRow);
      }
      
      const lista = demoData.presupuesto[area];

      const mapaReal = {};
      demoData.real[area].forEach(r => {
        mapaReal[r.categoria] = (mapaReal[r.categoria] || 0) + r.monto * f;
      });

      const grupos = {};
      lista.forEach((item, index) => {
        const cat = item.categoria;
        if (!grupos[cat]) grupos[cat] = { total: 0, items: [], real: 0 };
        grupos[cat].total += item.monto * f;
        grupos[cat].real = mapaReal[cat] || 0;
        grupos[cat].items.push({ ...item, __index: index });
      });

      Object.keys(grupos).forEach(cat => {
        const grupo = grupos[cat];

        if (grupo.items.length === 1){
          const item = grupo.items[0];
          const wrapper = document.createElement("div");
          wrapper.className = "row-wrapper";

          const deleteBg = document.createElement("div");
          deleteBg.className = "row-delete-bg";
          deleteBg.textContent = "Eliminar";

          const row = document.createElement("div");
          row.className = "row";
          row.dataset.area = area;
          row.dataset.index = item.__index;

          const labelSpan = document.createElement("span");
          labelSpan.textContent = item.label || item.categoria;

          const montoSpan = document.createElement("span");
          montoSpan.textContent = formatear(item.monto * f);

          row.appendChild(labelSpan);
          row.appendChild(montoSpan);

          enableSwipe(row, () => {
            deleteTarget = { area, index: item.__index };
            document.getElementById('deleteConfirm').classList.add('show');
          });

          wrapper.appendChild(deleteBg);
          wrapper.appendChild(row);

          if (area === 'gastos' && grupo.real > 0) {
            const pct = Math.min((grupo.real / grupo.total) * 100, 100);
            const progressWrap = document.createElement('div');
            progressWrap.className = 'progress-wrapper';
            progressWrap.innerHTML = `
              <div class="progress-bar">
                <div class="progress-fill ${getProgressColor(pct, true)}" style="width: ${pct}%"></div>
              </div>
              <div class="progress-label">${Math.round(pct)}% del presupuesto</div>
            `;
            wrapper.appendChild(progressWrap);
          }

          cont.appendChild(wrapper);
          return;
        }

        const groupDiv = document.createElement("div");
        groupDiv.className = "cat-group collapsed";

        const header = document.createElement("div");
        header.className = "cat-group-header";

        const titleDiv = document.createElement("div");
        titleDiv.className = "cat-group-title";

        const nameSpan = document.createElement("span");
        nameSpan.className = "cat-group-name";
        nameSpan.textContent = cat;

        const summarySpan = document.createElement("span");
        summarySpan.className = "cat-group-summary";
        summarySpan.textContent = `${grupo.items.length} partida(s)`;

        titleDiv.appendChild(nameSpan);
        titleDiv.appendChild(summarySpan);

        const rightDiv = document.createElement("div");
        const totalSpan = document.createElement("span");
        totalSpan.className = "cat-group-total";
        totalSpan.textContent = formatear(grupo.total);

        const arrowSpan = document.createElement("span");
        arrowSpan.className = "cat-group-arrow";
        arrowSpan.textContent = "âŒ„";

        rightDiv.appendChild(totalSpan);
        rightDiv.appendChild(arrowSpan);

        header.appendChild(titleDiv);
        header.appendChild(rightDiv);

        const body = document.createElement("div");
        body.className = "cat-group-body";

        grupo.items.forEach(item => {
          const wrapper = document.createElement("div");
          wrapper.className = "row-wrapper";

          const deleteBg = document.createElement("div");
          deleteBg.className = "row-delete-bg";
          deleteBg.textContent = "Eliminar";

          const subRow = document.createElement("div");
          subRow.className = "cat-sub-row";
          subRow.dataset.area = area;
          subRow.dataset.index = item.__index;

          const labelSpan = document.createElement("span");
          let subLabel = "";
          if (item.label){
            const parts = item.label.split(" â€“ ");
            subLabel = parts.length > 1 ? parts.slice(1).join(" â€“ ") : item.label;
          } else {
            subLabel = item.categoria;
          }
          labelSpan.textContent = subLabel;

          const montoSpan = document.createElement("span");
          montoSpan.textContent = formatear(item.monto * f);

          subRow.appendChild(labelSpan);
          subRow.appendChild(montoSpan);

          enableSwipe(subRow, () => {
            deleteTarget = { area, index: item.__index };
            document.getElementById('deleteConfirm').classList.add('show');
          });

          wrapper.appendChild(deleteBg);
          wrapper.appendChild(subRow);
          body.appendChild(wrapper);
        });

        if (area === 'gastos' && grupo.real > 0) {
          const pct = Math.min((grupo.real / grupo.total) * 100, 100);
          const progressWrap = document.createElement('div');
          progressWrap.className = 'progress-wrapper';
          progressWrap.style.marginTop = '8px';
          progressWrap.innerHTML = `
            <div class="progress-bar">
              <div class="progress-fill ${getProgressColor(pct, true)}" style="width: ${pct}%"></div>
            </div>
            <div class="progress-label">${Math.round(pct)}% del presupuesto Â· Real: ${formatear(grupo.real)}</div>
          `;
          body.appendChild(progressWrap);
        }

        header.addEventListener("click", () => groupDiv.classList.toggle("collapsed"));
        groupDiv.appendChild(header);
        groupDiv.appendChild(body);
        cont.appendChild(groupDiv);
      });
    }

    function mostrarInputInline(area, categoria, subcategoria) {
      const contId = area === 'ingresos' ? 'listaIngresos' : 
                     area === 'gastos' ? 'listaGastos' : 'listaAhorro';
      const cont = document.getElementById(contId);
      
      // Remover cualquier input-row existente
      const existingInputRow = cont.querySelector('.input-row');
      if (existingInputRow) {
        existingInputRow.remove();
      }
      
      // Crear nueva fila de input
      const inputRow = document.createElement('div');
      inputRow.className = 'input-row';
      
      const label = `${categoria} â€“ ${subcategoria}`;
      
      inputRow.innerHTML = `
        <div class="input-row-label">${label}</div>
        <div class="input-row-field">
          <input type="number" 
                 class="input-row-monto" 
                 id="inputMonto${area}" 
                 placeholder="0.00" 
                 step="0.01"
                 inputmode="decimal"
                 autofocus>
        </div>
        <div class="input-row-actions">
          <button class="input-row-btn cancelar" onclick="cancelarInput('${area}')">Cancelar</button>
          <button class="input-row-btn guardar" onclick="guardarInput('${area}', '${categoria}', '${subcategoria}')">Guardar</button>
        </div>
      `;
      
      // Insertar al inicio
      cont.insertBefore(inputRow, cont.firstChild);
      
      // Enfocar el input
      setTimeout(() => {
        document.getElementById(`inputMonto${area}`).focus();
      }, 100);
    }

    function cancelarInput(area) {
      const contId = area === 'ingresos' ? 'listaIngresos' : 
                     area === 'gastos' ? 'listaGastos' : 'listaAhorro';
      const cont = document.getElementById(contId);
      const inputRow = cont.querySelector('.input-row');
      if (inputRow) {
        inputRow.remove();
      }
    }

    function guardarInput(area, categoria, subcategoria) {
      const input = document.getElementById(`inputMonto${area}`);
      const valor = parseFloat(input.value);
      
      if (!valor || valor <= 0) {
        showToast('âš ï¸ Ingresa un monto vÃ¡lido');
        return;
      }

      const f = factorTipo();
      const label = `${categoria} â€“ ${subcategoria}`;
      const montoMensual = valor / f;

      demoData.presupuesto[area].push({
        categoria: categoria,
        label: label,
        monto: montoMensual
      });

      // Remover el input row
      cancelarInput(area);
      
      showLoading();
      setTimeout(() => {
        renderSecciones();
        renderTotales();
        renderComparativo();
        hideLoading();
        showToast(`âœ… ${subcategoria}: ${formatear(valor)}`);
      }, 200);
    }

    function renderSecciones(){
      renderArea("ingresos", "listaIngresos");
      renderArea("gastos", "listaGastos");
      renderArea("ahorro", "listaAhorro");
    }

    function renderTotales(){
      const tIng = sumarLista(demoData.presupuesto.ingresos);
      const tGas = sumarLista(demoData.presupuesto.gastos);
      const tAh  = sumarLista(demoData.presupuesto.ahorro);
      const disp = tIng - tGas - tAh;

      const totalIngresosEl = document.getElementById("totalIngresos");
      const totalGastosEl = document.getElementById("totalGastos");
      const totalAhorroEl = document.getElementById("totalAhorro");
      const totalDisponibleEl = document.getElementById("totalDisponible");

      if (totalIngresosEl) totalIngresosEl.textContent = formatear(tIng);
      if (totalGastosEl) totalGastosEl.textContent = formatear(tGas);
      if (totalAhorroEl) totalAhorroEl.textContent = formatear(tAh);
      if (totalDisponibleEl) totalDisponibleEl.textContent = formatear(disp);
    }

    function actualizarBanner(pres, real, area){
      const banner = document.getElementById("statusBanner");
      if (!banner) return;

      banner.classList.remove("green","yellow","red");

      if (!pres || pres === 0){
        banner.classList.add("yellow");
        banner.innerHTML = `<span>Sin presupuesto en esta Ã¡rea.</span><span></span>`;
        return;
      }

      const diff = real - pres;
      const ratio = real / pres;
      const pct = Math.round(ratio * 100);

      const umbral = pres * 0.05;
      const dentroRango = Math.abs(diff) <= umbral;
      let texto = "";

      if (area === "ingresos"){
        if (diff > umbral){ banner.classList.add("green"); texto = "<strong>Ingresos arriba.</strong> Ganaste mÃ¡s de lo planificado."; }
        else if (dentroRango){ banner.classList.add("yellow"); texto = "<strong>Cerca de lo planificado.</strong>"; }
        else { banner.classList.add("red"); texto = "<strong>Ingresos abajo.</strong> EntrÃ³ menos de lo esperado."; }
      } else if (area === "gastos"){
        if (diff < -umbral){ banner.classList.add("green"); texto = "<strong>Vas bien.</strong> Gasto por debajo del presupuesto."; }
        else if (dentroRango){ banner.classList.add("yellow"); texto = "<strong>Casi al lÃ­mite.</strong> Muy cerca del presupuesto."; }
        else { banner.classList.add("red"); texto = "<strong>Te pasaste.</strong> Gasto por encima del presupuesto."; }
      } else {
        if (diff > umbral){ banner.classList.add("green"); texto = "<strong>Buen trabajo.</strong> Ahorro por encima de lo planificado."; }
        else if (dentroRango){ banner.classList.add("yellow"); texto = "<strong>Cerca de la meta.</strong>"; }
        else { banner.classList.add("red"); texto = "<strong>Ahorro bajo.</strong> EstÃ¡s ahorrando menos de lo planeado."; }
      }

      banner.innerHTML = `<span>${texto}</span><span id="bannerPct">${pct}%</span>`;
    }

    function renderTopDeviations(){
      const cont = document.getElementById("topDeviations");
      cont.innerHTML = "";

      if (areaComparativa !== "gastos"){
        cont.style.display = "none";
        return;
      }

      const f = factorTipo();
      cont.style.display = "block";

      const mapaPres = {};
      demoData.presupuesto.gastos.forEach(g => mapaPres[g.categoria] = (mapaPres[g.categoria] || 0) + g.monto * f);

      const mapaReal = {};
      demoData.real.gastos.forEach(g => mapaReal[g.categoria] = (mapaReal[g.categoria] || 0) + g.monto * f);

      const categorias = new Set([...Object.keys(mapaPres), ...Object.keys(mapaReal)]);
      const desviaciones = [];

      categorias.forEach(cat => {
        const pres = mapaPres[cat] || 0;
        const real = mapaReal[cat] || 0;
        const diff = real - pres;
        if (Math.abs(diff) > 0) desviaciones.push({ cat, pres, real, diff });
      });

      desviaciones.sort((a,b) => Math.abs(b.diff) - Math.abs(a.diff));
      const top = desviaciones.slice(0,3);

      if (top.length === 0){
        cont.innerHTML = "<div class='top-dev-detail'>Sin desviaciones relevantes.</div>";
        return;
      }

      top.forEach(item => {
        const row = document.createElement("div");
        row.className = "top-dev-item";

        const left = document.createElement("div");
        left.innerHTML = `
          <div class="top-dev-name">${item.cat}</div>
          <div class="top-dev-detail">Pres: ${formatear(item.pres)} Â· Real: ${formatear(item.real)}</div>
        `;

        const diffSpan = document.createElement("div");
        diffSpan.className = "top-dev-diff " + (item.diff > 0 ? "positive" : "negative");
        const signo = item.diff > 0 ? "+" : "-";
        diffSpan.textContent = signo + formatear(Math.abs(item.diff));

        row.appendChild(left);
        row.appendChild(diffSpan);
        cont.appendChild(row);
      });
    }

    function renderComparativo(){
      const f = factorTipo();
      const presLista = demoData.presupuesto[areaComparativa];
      const realLista = demoData.real[areaComparativa];

      const totalPres = sumarLista(presLista);
      const totalReal = realLista.reduce((acc, item) => acc + item.monto * f, 0);

      const diffRaw = totalReal - totalPres;
      let diffVisual = diffRaw;
      if (areaComparativa === "gastos") diffVisual = totalPres - totalReal;

      const miniPresEl = document.getElementById("miniPres");
      const miniRealEl = document.getElementById("miniReal");
      const diffSpan = document.getElementById("miniDiff");

      if (miniPresEl) miniPresEl.textContent = formatear(totalPres);
      if (miniRealEl) miniRealEl.textContent = formatear(totalReal);

      if (diffSpan) {
        diffSpan.classList.remove("diff-positive","diff-negative");

        if (diffVisual === 0){
          diffSpan.textContent = formatear(0);
        } else {
          const signo = diffVisual > 0 ? "+" : "-";
          diffSpan.textContent = signo + formatear(Math.abs(diffVisual));
          diffSpan.classList.add(diffVisual > 0 ? "diff-positive" : "diff-negative");
        }
      }

      actualizarBanner(totalPres, totalReal, areaComparativa);

      // Renderizar Bullet Chart
      renderBulletChart(totalPres, totalReal);

      renderTopDeviations();
    }

    function renderBulletChart(presupuesto, real) {
      const bulletBudget = document.getElementById('bulletBudget');
      const bulletActual = document.getElementById('bulletActual');
      const bulletBudgetText = document.getElementById('bulletBudgetText');
      const bulletActualText = document.getElementById('bulletActualText');

      if (!bulletBudget || !bulletActual) return;

      // Determinar el mÃ¡ximo para el ancho
      const maxValue = Math.max(presupuesto, real, 1); // Evitar divisiÃ³n por 0

      // Calcular porcentajes
      const budgetWidth = (presupuesto / maxValue) * 100;
      const actualWidth = (real / maxValue) * 100;

      // Aplicar anchos
      bulletBudget.style.width = budgetWidth + '%';
      bulletActual.style.width = actualWidth + '%';

      // Actualizar textos
      if (bulletBudgetText) bulletBudgetText.textContent = formatear(presupuesto);
      if (bulletActualText) bulletActualText.textContent = formatear(real);

      // Aplicar colores segÃºn el Ã¡rea y si estÃ¡ sobre o bajo presupuesto
      bulletActual.classList.remove('over-budget', 'under-budget');
      
      if (areaComparativa === 'gastos') {
        // Para gastos: verde si gastaste menos, rojo si gastaste mÃ¡s
        if (real > presupuesto) {
          bulletActual.classList.add('over-budget');
        } else if (real < presupuesto) {
          bulletActual.classList.add('under-budget');
        }
      } else if (areaComparativa === 'ingresos') {
        // Para ingresos: verde si ganaste mÃ¡s, rojo si ganaste menos
        if (real > presupuesto) {
          bulletActual.classList.add('under-budget');
        } else if (real < presupuesto) {
          bulletActual.classList.add('over-budget');
        }
      } else {
        // Para ahorro: verde si ahorraste mÃ¡s, rojo si ahorraste menos
        if (real > presupuesto) {
          bulletActual.classList.add('under-budget');
        } else if (real < presupuesto) {
          bulletActual.classList.add('over-budget');
        }
      }
    }

    function configurarToggleTipo(){
      const toggle = document.getElementById("toggleTipo");
      const selectMonth = document.getElementById("selectMonth");

      toggle.querySelectorAll("span").forEach(span => {
        span.addEventListener("click", () => {
          const nuevo = span.getAttribute("data-tipo");
          if (nuevo === tipoActual) return;
          tipoActual = nuevo;

          toggle.querySelectorAll("span").forEach(s => s.classList.remove("active"));
          span.classList.add("active");

          selectMonth.style.display = (tipoActual === "mensual") ? "" : "none";

          renderSecciones();
          renderTotales();
          renderComparativo();
        });
      });

      selectMonth.style.display = "";
    }

    function configurarChips(){
      const chips = document.getElementById("chipsArea");
      chips.querySelectorAll(".chip").forEach(chip => {
        chip.addEventListener("click", () => {
          const area = chip.getAttribute("data-area");
          if (area === areaComparativa) return;
          areaComparativa = area;

          chips.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
          chip.classList.add("active");

          renderComparativo();
        });
      });
    }

    // Renderizar categorÃ­as en modal
    function renderizarCategoriasModal(area, contenedorId) {
      const contenedor = document.getElementById(contenedorId);
      contenedor.innerHTML = '';

      const cats = categorias[area];
      
      Object.entries(cats).forEach(([categoria, subcategorias]) => {
        const bloqueDiv = document.createElement('div');
        bloqueDiv.className = 'bloque-categoria-modal';

        const tituloDiv = document.createElement('div');
        tituloDiv.className = 'titulo-categoria-modal';
        tituloDiv.onclick = () => toggleSubcategoriasModal(tituloDiv);

        const nombreSpan = document.createElement('span');
        nombreSpan.className = 'titulo-cat-nombre-modal';
        nombreSpan.textContent = categoria;

        const arrowSpan = document.createElement('span');
        arrowSpan.textContent = 'âŒ„';
        arrowSpan.style.color = 'var(--muted)';
        arrowSpan.style.transition = 'transform 0.3s ease';

        tituloDiv.appendChild(nombreSpan);
        tituloDiv.appendChild(arrowSpan);

        const subDiv = document.createElement('div');
        subDiv.className = 'subcategorias-modal';

        subcategorias.forEach(sub => {
          const filaDiv = document.createElement('div');
          filaDiv.className = 'fila-sub-modal';

          const nombreSubSpan = document.createElement('span');
          nombreSubSpan.className = 'fila-sub-nombre-modal';
          nombreSubSpan.textContent = sub;

          filaDiv.appendChild(nombreSubSpan);

          filaDiv.addEventListener('click', () => {
            seleccionarSubcategoria(area, categoria, sub);
          });

          subDiv.appendChild(filaDiv);
        });

        bloqueDiv.appendChild(tituloDiv);
        bloqueDiv.appendChild(subDiv);
        contenedor.appendChild(bloqueDiv);
      });
    }

    function toggleSubcategoriasModal(element) {
      const subcats = element.closest('.bloque-categoria-modal').querySelector('.subcategorias-modal');
      const arrow = element.querySelector('span:last-child');
      const allSubcats = document.querySelectorAll('.subcategorias-modal');
      
      allSubcats.forEach(sc => {
        if (sc !== subcats) {
          sc.classList.remove('activo');
          const otherArrow = sc.previousElementSibling?.querySelector('span:last-child');
          if (otherArrow) otherArrow.style.transform = '';
        }
      });
      
      subcats.classList.toggle('activo');
      if (subcats.classList.contains('activo')) {
        arrow.style.transform = 'rotate(180deg)';
      } else {
        arrow.style.transform = '';
      }
    }

    function toggleBloqueModal(encabezado) {
      const parent = encabezado.closest('.bloque-sector-modal');
      parent.classList.toggle('abierto');
    }

    function abrirModalCategorias(event, area) {
      event.stopPropagation();
      areaSeleccionada = area;
      
      // Asegurar que la secciÃ³n estÃ© abierta
      const section = event.target.closest('.section');
      section.classList.remove('collapsed');
      
      const modal = document.getElementById('modalCategorias');
      
      // Renderizar todas las categorÃ­as
      renderizarCategoriasModal('ingresos', 'contenedorIngresosModal');
      renderizarCategoriasModal('gastos', 'contenedorGastosModal');
      renderizarCategoriasModal('ahorro', 'contenedorAhorroModal');
      
      modal.classList.add('open');
    }

    function cerrarModalCategorias() {
      document.getElementById('modalCategorias').classList.remove('open');
    }

    function seleccionarSubcategoria(area, categoria, subcategoria) {
      categoriaSeleccionada = categoria;
      subcategoriaSeleccionada = subcategoria;
      areaSeleccionada = area;
      
      // Cerrar modal
      cerrarModalCategorias();
      
      // Mostrar input inline
      mostrarInputInline(area, categoria, subcategoria);
    }

    function configurarAcordeones(){
      document.querySelectorAll(".accordion-header").forEach(header => {
        header.addEventListener("click", (e) => {
          // Evitar toggle si se hace click en el botÃ³n +
          if (e.target.classList.contains('btn-add-section')) return;
          header.closest(".section").classList.toggle("collapsed");
        });
      });
    }

    function configurarTotalesCollapsible(){
      const card = document.getElementById("totalsCard");
      const toggle = document.getElementById("totalsToggle");
      toggle.addEventListener("click", () => card.classList.toggle("collapsed"));
      // Ahora inicia abierto por defecto
    }

    function showToast(msg){
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 2000);
    }

    function showLoading(){
      document.getElementById("loadingOverlay").classList.add("show");
    }

    function hideLoading(){
      document.getElementById("loadingOverlay").classList.remove("show");
    }

    function configurarGuardar(){
      document.getElementById("btnGuardar").addEventListener("click", () => {
        showLoading();
        setTimeout(() => {
          hideLoading();
          showToast("ðŸ’¾ Presupuesto guardado");
        }, 800);
      });
    }

    function configurarDeleteConfirm(){
      document.getElementById('btnDeleteCancel').addEventListener('click', () => {
        document.getElementById('deleteConfirm').classList.remove('show');
        deleteTarget = null;
      });

      document.getElementById('btnDeleteConfirm').addEventListener('click', () => {
        if (deleteTarget) {
          const { area, index } = deleteTarget;
          demoData.presupuesto[area].splice(index, 1);
          
          showLoading();
          setTimeout(() => {
            renderSecciones();
            renderTotales();
            renderComparativo();
            hideLoading();
            showToast("ðŸ—‘ï¸ Elemento eliminado");
          }, 300);
          
          document.getElementById('deleteConfirm').classList.remove('show');
          deleteTarget = null;
        }
      });
    }

    // Click fuera del modal
    document.getElementById('modalCategorias').addEventListener('click', (e) => {
      if (e.target.id === 'modalCategorias') {
        cerrarModalCategorias();
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      configurarToggleTipo();
      configurarChips();
      configurarAcordeones();
      configurarTotalesCollapsible();
      configurarGuardar();
      configurarDeleteConfirm();

      renderSecciones();
      renderTotales();
      renderComparativo();
    });
  </script>
</body>
</html>
