<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Modal Exportar Datos · Cada Menudo</title>
  <style>
    :root{
      --brand:#594AE2;
      --brand-2:#7459D9;
      --ink:#0f172a;
      --muted:#64748B;
      --bg:#f7f8fb;
      --card:#fff;
      --shadow:0 10px 30px rgba(15,23,42,.12);
      --danger:#ef4444;
    }
    body{
      margin:0;
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
      color:var(--ink);
      background:var(--bg);
    }
    .demo{padding:20px}
    .btn-primary{
      background:var(--brand); color:#fff; padding:12px 16px; border-radius:12px;
      font-weight:700; border:0; cursor:pointer;
    }

    /* Modal (top-sheet) */
    .modal{
      position:fixed; inset:0; display:none;
      align-items:flex-start; justify-content:center;
      padding:12px; background:rgba(2,6,23,.4);
      backdrop-filter: blur(4px);
    }
    .modal[aria-hidden="false"]{ display:flex }

    .dialog{
      background:var(--card); width:min(760px, 100%);
      border-radius:0 0 20px 20px; /* pegado arriba */
      box-shadow:var(--shadow); overflow:hidden;
      margin-top: max(8px, env(safe-area-inset-top));
      max-height: 92vh; display:flex; flex-direction:column;
      position:relative;
    }
    .dialog-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px; border-bottom:1px solid #e5e7eb; background:#fff;
    }
    .dialog-title{ font-size:1.1rem; font-weight:800 }
    .dialog-subtitle{ font-size:.9rem; color:var(--muted) }

    .dialog-content{ padding:10px 14px; overflow:auto }
    .grid{ display:grid; grid-template-columns:1fr; gap:12px }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:12px }

    /* Controles */
    .two-col{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .radio{
      display:flex; align-items:center; gap:10px;
      border:1px solid #e5e7eb; border-radius:12px; padding:10px;
    }
    .cat-grid{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .cat-header{
      display:flex; align-items:center; gap:10px; margin-bottom:8px;
      border:1px dashed #e5e7eb; border-radius:12px; padding:8px 10px; color:var(--muted);
      font-weight:700;
    }
    .formats{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }

    /* Presets */
    .preset-bar{
      display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-bottom:8px;
    }
    .preset-btn{
      border:1px solid #e5e7eb; background:#fff; border-radius:999px;
      padding:8px 10px; font-weight:700; cursor:pointer;
    }
    .preset-btn.active{ border-color:#d4d8ff; box-shadow:0 0 0 3px rgba(89,74,226,.15) }

    /* Validación */
    .hint{
      font-size:.85rem; margin-top:8px; color:var(--danger); display:none;
    }
    .invalid .hint{ display:block; }
    .invalid .radio, .invalid input[type="date"]{
      border-color: rgba(239,68,68,.9);
    }

    /* Footer */
    .dialog-footer{
      padding:12px 14px; border-top:1px solid #e5e7eb; background:#fff;
      display:grid; gap:8px;
    }
    .btns{
      display:grid; grid-template-columns:1fr 1fr; gap:8px;
    }
    .btn{
      border:0; border-radius:12px; padding:12px 14px; font-weight:700; cursor:pointer; width:100%;
    }
    .btn-secondary{ background:#f3f4f6 }
    .btn-accent{ background:var(--brand-2); color:#fff }
    .btn[disabled]{ opacity:.5; cursor:not-allowed }
    #mensajeStatus{ text-align:center; font-size:.9rem; color:var(--muted); display:none }

    /* Toast */
    .toast {
      position: absolute;
      top: 8px; left: 50%; transform: translateX(-50%) translateY(-10px);
      background: #0ea5e9; color:#fff;
      padding:10px 14px; border-radius:12px;
      font-weight:700; box-shadow: 0 8px 20px rgba(2,6,23,.18);
      z-index: 5; pointer-events:none;
      opacity:0; transition: opacity .2s ease, transform .2s ease;
    }
    .toast.show { opacity:1; transform: translateX(-50%) translateY(0); }

    /* Ultra compacto */
    @media (max-width: 340px){
      .cat-grid, .formats, .btns, .preset-bar{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="demo">
    <button class="btn-primary" id="abrirModal">Abrir modal</button>
  </div>

  <!-- Modal Exportar -->
  <div class="modal" id="modalExport" aria-hidden="true">
    <div class="dialog">
      <div id="toast" class="toast" role="status" aria-live="polite"></div>

      <div class="dialog-header">
        <div>
          <div class="dialog-title">Exportar datos</div>
          <div class="dialog-subtitle">Elige qué descargar y en qué formato</div>
        </div>
        <button class="btn" id="cerrarModal" style="width:auto;background:none">✕</button>
      </div>

      <form class="dialog-content" onsubmit="return false">
        <div class="grid">
          <!-- Categorías -->
          <div class="card" id="cardCats">
            <h3 style="margin:0 0 8px">Categorías</h3>
            <label class="cat-header">
              <input type="checkbox" id="selectAllCats" /> Seleccionar todo
            </label>
            <div id="listaCategorias" class="cat-grid"></div>
            <div class="hint">Selecciona al menos una categoría.</div>
          </div>

          <!-- Rango de tiempo -->
          <div class="card" id="cardDates">
            <h3 style="margin:0 0 8px">Rango de tiempo</h3>
            <div class="preset-bar">
              <button type="button" class="preset-btn" data-preset="30d">30 días</button>
              <button type="button" class="preset-btn" data-preset="90d">90 días</button>
              <button type="button" class="preset-btn" data-preset="ytd">YTD</button>
              <button type="button" class="preset-btn" data-preset="12m">12 meses</button>
            </div>
            <div class="two-col">
              <input type="date" id="desde" />
              <input type="date" id="hasta" />
            </div>
            <div class="hint">Elige un rango válido.</div>
          </div>

          <!-- Formato -->
          <div class="card" id="cardFormat">
            <h3 style="margin:0 0 8px">Formato</h3>
            <div class="formats">
              <label class="radio"><input type="radio" name="formato" value="csv" /> CSV</label>
              <label class="radio"><input type="radio" name="formato" value="xlsx" /> Excel</label>
              <label class="radio"><input type="radio" name="formato" value="gsheet" /> Google Sheets</label>
              <label class="radio"><input type="radio" name="formato" value="pdf" /> PDF</label>
            </div>
            <div class="hint">Selecciona un formato.</div>
          </div>
        </div>
      </form>

      <div class="dialog-footer">
        <div class="btns">
          <button class="btn btn-secondary" id="btnCancelar">Cancelar</button>
          <button class="btn btn-accent" id="btnExportar" disabled>Exportar</button>
        </div>
        <div id="mensajeStatus">Bajando…</div>
      </div>
    </div>
  </div>

  <script>
    const CATEGORIAS = [
      { id: 'ingresos', nombre: 'Ingresos' },
      { id: 'gastos', nombre: 'Gastos' },
      { id: 'ahorro', nombre: 'Ahorro' },
      { id: 'metas', nombre: 'Metas' },
      { id: 'transacciones', nombre: 'Transacciones' }
    ];

    const modal = document.getElementById('modalExport');
    const abrirModal = document.getElementById('abrirModal');
    const cerrarModal = document.getElementById('cerrarModal');
    const btnCancelar = document.getElementById('btnCancelar');
    const btnExportar = document.getElementById('btnExportar');
    const mensajeStatus = document.getElementById('mensajeStatus');
    const listaCategorias = document.getElementById('listaCategorias');
    const selectAllCats = document.getElementById('selectAllCats');
    const desde = document.getElementById('desde');
    const hasta = document.getElementById('hasta');

    const cardCats = document.getElementById('cardCats');
    const cardDates = document.getElementById('cardDates');
    const cardFormat = document.getElementById('cardFormat');

    // Render categorías
    CATEGORIAS.forEach(cat => {
      const label = document.createElement('label');
      label.className = 'radio';
      label.innerHTML = `<input type="checkbox" class="cat-check" value="${cat.id}" /> ${cat.nombre}`;
      listaCategorias.appendChild(label);
    });
    const catChecks = () => Array.from(document.querySelectorAll('.cat-check'));

    // Open/close
    const openModal = () => modal.setAttribute('aria-hidden','false');
    const closeModal = () => modal.setAttribute('aria-hidden','true');
    abrirModal.onclick = openModal;
    cerrarModal.onclick = closeModal;
    btnCancelar.onclick = closeModal;
    modal.addEventListener('click', e => { if(e.target===modal) closeModal(); });
    window.addEventListener('keydown', e => { if(e.key==='Escape' && modal.getAttribute('aria-hidden')==='false') closeModal(); });

    // Presets
    const fmt = d=>d.toISOString().slice(0,10);
    const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x};
    const startOfYear=(d)=>{const x=new Date(d);x.setMonth(0,1);return x};
    function applyPreset(kind){
      const now=new Date();
      if(kind==='30d'){ hasta.value=fmt(now); desde.value=fmt(addDays(now,-30)); }
      else if(kind==='90d'){ hasta.value=fmt(now); desde.value=fmt(addDays(now,-90)); }
      else if(kind==='ytd'){ hasta.value=fmt(now); desde.value=fmt(startOfYear(now)); }
      else if(kind==='12m'){ hasta.value=fmt(now); desde.value=fmt(addDays(now,-365)); }
      updateExportState(); highlightPreset(kind);
    }
    function highlightPreset(kind){
      document.querySelectorAll('.preset-btn').forEach(b=>{
        b.classList.toggle('active', b.dataset.preset===kind);
      });
    }
    document.querySelectorAll('.preset-btn').forEach(btn=>{
      btn.addEventListener('click', ()=> applyPreset(btn.dataset.preset));
    });

    // Select All
    selectAllCats.addEventListener('change', ()=>{
      catChecks().forEach(cb=>cb.checked=selectAllCats.checked);
      updateExportState();
    });
    document.addEventListener('change', e=>{
      if(e.target.classList?.contains('cat-check')){
        const all=catChecks();
        selectAllCats.checked= all.length>0 && all.every(cb=>cb.checked);
      }
      updateExportState();
    });

    // Validación
    function updateExportState(){
      const cats=catChecks().filter(cb=>cb.checked);
      const formato=document.querySelector('input[name="formato"]:checked');
      const fechasOK=!!desde.value && !!hasta.value && (desde.value<=hasta.value);
      btnExportar.disabled=!(cats.length>0 && formato && fechasOK);
      cardCats.classList.toggle('invalid', !(cats.length>0));
      cardFormat.classList.toggle('invalid', !Boolean(formato));
      cardDates.classList.toggle('invalid', !fechasOK);
    }

    // Toast
    function showToast(text, ms=1500){
      const t=document.getElementById('toast');
      t.textContent=text;
      t.classList.add('show');
      t.scrollIntoView({block:'nearest', behavior:'smooth'});
      setTimeout(()=>t.classList.remove('show'), ms);
    }

    // Exportar
    btnExportar.addEventListener('click', ()=>{
      mensajeStatus.style.display='block';
      mensajeStatus.textContent='Bajando…';
      btnExportar.disabled=true;
      setTimeout(()=>{
        mensajeStatus.style.display='none';
        showToast('✅ Completado',1200);
        setTimeout(()=>{ btnExportar.disabled=false; closeModal(); },1200);
      },2000);
    });

    updateExportState();
  </script>
</body>
</html>
