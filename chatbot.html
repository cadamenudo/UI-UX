<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chatbot ‚Äì Cada Menudo</title>
<link rel="stylesheet" href="https://cadamenudo.github.io/UI-UX/css-fonts.css"/>

<style>
  :root{
    --primary:#3956E8; --secondary:#7459D9; --bg:#ffffff; --text:#0d1320;
    --muted:#6b7280; --border:#E6E8F0; --shadow:0 8px 28px rgba(15,23,42,.12);
    --bot:#F3F6FF; --user:#F7F8FB;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:"Greycliff CF",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

  /* Launcher (bot√≥n flotante) */
  .chat-launcher{
    position:fixed; right:20px; bottom:20px;
    width:80px; height:80px;
    border-radius:50%;
    border:none; background:var(--primary); color:#fff;
    display:grid; place-items:center;
    box-shadow:var(--shadow); cursor:pointer;
    z-index:9999;  /* debajo de la ventana */
  }
  .launcher-logo{
    width:56px; height:56px;
    box-sizing:border-box;
    border-radius:50%;
    background:#fff; padding:8px;
    object-fit:contain;
    pointer-events:none; /* no bloquea el click */
  }

  /* Ventana del chat (por encima del launcher) */
  .chat-window{
    position:fixed; right:20px; bottom:92px;
    width:360px; max-width:92vw; height:560px; max-height:78vh;
    display:none; /* toggle => grid */
    grid-template-rows:auto auto 1fr auto auto;
    background:#fff; border-radius:18px; overflow:hidden;
    box-shadow:var(--shadow);
    z-index:10001; /* clave */
    border:1px solid var(--border);
  }

  /* Header */
  .chat-header{ display:flex; align-items:center; gap:12px; padding:12px 14px; background:#fff; border-bottom:1px solid var(--border) }
  .bot-logo{ width:40px; height:40px; border-radius:50%; background:#fff; padding:4px; object-fit:contain }
  .chat-title{font-weight:700; color:#3956E8;}
  .header-actions{margin-left:auto}
  .icon-btn{ background:transparent; border:none; color:#94A3B8; font-size:18px; cursor:pointer; padding:6px }

  /* Input */
  .input-top{ padding:10px 12px; border-bottom:1px solid var(--border); background:#fff }
  .input-row{ display:flex; gap:8px }
  .input-row input{ flex:1; padding:12px; border:1px solid var(--border); border-radius:12px; font-size:14px; outline:none; }
  .input-row input::placeholder{ color:#98A2B3; }
  .input-row button{ padding:12px 14px; border:none; border-radius:12px; background:#3956E8; color:#fff; font-weight:700; cursor:pointer }

  /* Body */
  .chat-body{padding:14px; overflow:auto; background:#fff}
  .msg{display:flex; margin:8px 0}
  .msg.bot{justify-content:flex-start}
  .msg.user{justify-content:flex-end}
  .bubble{ max-width:78%; padding:10px 12px; border-radius:14px; font-size:14px; line-height:1.35; border:1px solid var(--border) }
  .msg.bot .bubble{background:var(--bot)}
  .msg.user .bubble{background:var(--user)}
  .meta{display:block; color:#9AA4B2; font-size:11px; margin-top:4px}

  /* Temas + acorde√≥n */
  .topic-grid{ display:flex; flex-wrap:wrap; gap:8px; margin-top:4px; }
  .topic-btn{ border:1px solid var(--border); background:#fff; color:#374151; padding:8px 12px; border-radius:999px; font-size:12px; cursor:pointer; }
  .cat-panel{ border:1px dashed var(--border); background:#fff; border-radius:12px; padding:10px; }
  .cat-title{ font-weight:700; color:#3956E8; margin-bottom:6px; }
  .q-list{ display:flex; flex-direction:column; gap:6px; }
  .q-item{ border:1px solid var(--border); border-radius:10px; background:#fff; }
  .q-btn{ width:100%; text-align:left; background:#fff; border:none; cursor:pointer; padding:10px 12px; font-size:14px; color:#0d1320; border-radius:10px; }
  .q-btn:hover{ background:#F7F8FB; }
  .ans{ display:none; border-top:1px solid var(--border); }
  .ans.open{ display:block; }
  .ans-inner{ padding:10px 12px; font-size:14px; background:#F9FAFB; border-radius:0 0 10px 10px; }

  /* Toolbar discreta */
  .toolbar{
    display:flex; justify-content:flex-end; align-items:center; gap:12px;
    padding:6px 10px; border-top:1px solid var(--border); background:#fff;
  }
  .tool{ background:none; border:none; color:#8a93a6; font-size:12px; padding:0; cursor:pointer; text-decoration:underline; text-underline-offset:2px; }
  .tool:hover{ color:#4b5563; }

  /* Footer */
  .chat-footer{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 12px; border-top:1px solid var(--border); background:#fff }
  .privacy-link{ font-size:12px; color:#8A93A6; text-decoration:none }
  .privacy-link:hover{ color:#6B7280; text-decoration:underline }

  /* M√≥vil: full screen */
  @media (max-width:480px){
    .chat-window{ right:0; left:0; bottom:0; top:0; width:100vw; height:100vh; max-height:100vh; border-radius:0 }
  }
</style>
</head>
<body>

<button class="chat-launcher" id="launcher" aria-label="Abrir chat">
  <img class="launcher-logo" src="https://cadamenudo.github.io/UI-UX/isotopo%20blue%20w-name.png" alt="Cada Menudo"/>
</button>

<section class="chat-window" id="chatWindow" aria-live="polite">
  <header class="chat-header">
    <img class="bot-logo" src="https://cadamenudo.github.io/UI-UX/isotopo%20blue%20w-name.png" alt="Cada Menudo"/>
    <div><div class="chat-title">ChinChin Bot</div></div>
    <div class="header-actions"><button id="closeBtn" class="icon-btn" aria-label="Cerrar">‚úï</button></div>
  </header>

  <div class="input-top">
    <div class="input-row">
      <input id="userInput" type="text" placeholder="Pregunta" autocomplete="off"/>
      <button id="sendBtn" type="button">Enviar</button>
    </div>
  </div>

  <main class="chat-body" id="chatBody"></main>

  <div class="toolbar" id="toolbar">
    <button class="tool" id="clearBtn">üßπ Limpiar</button>
    <button class="tool" id="emailBtn">üìß Soporte</button>
  </div>

  <footer class="chat-footer">
    <a class="privacy-link" href="/privacidad.html" target="_blank" rel="noopener">Privacidad</a>
    <div style="font-size:12px; color:#8A93A6;">Cada Menudo</div>
  </footer>
</section>

<script>
(function(){
  const els = {};
  const byId = id => document.getElementById(id);
  const escapeHtml = s => { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; };
  const norm = s => (s==null?'':String(s)).trim().toLowerCase();
  const tokenize = s => (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9√°√©√≠√≥√∫√±√º\s]/gi,' ').split(/\s+/).filter(Boolean);

  const CATEGORY_ORDER = [
    "Misi√≥n y prop√≥sito","Registro y cuenta","Navegaci√≥n principal","Transacciones","Ingresos","Ahorro y metas",
    "Alertas de colores","Suscripci√≥n y pagos","Pagos y facturaci√≥n","Personalizaci√≥n","Soporte y educaci√≥n","Disponibilidad",
    "H√°bitos financieros","Funcionalidades principales","Recibos y facturas","Seguridad y privacidad","Soporte extendido",
    "Roadmap / Plan Premium","Educaci√≥n financiera y filosof√≠a","Historia y origen (Xavier Serbia)","Datos y descargas"
  ];
  const CATEGORY_ALIASES = {
    "cuenta y registro":"Registro y cuenta","registro":"Registro y cuenta","cuenta":"Registro y cuenta",
    "navegaci√≥n":"Navegaci√≥n principal","pagos":"Pagos y facturaci√≥n","facturaci√≥n":"Pagos y facturaci√≥n",
    "seguridad":"Seguridad y privacidad","privacidad":"Seguridad y privacidad",
    "roadmap":"Roadmap / Plan Premium","plan premium":"Roadmap / Plan Premium",
    "recibos":"Recibos y facturas","facturas":"Recibos y facturas",
    "features":"Funcionalidades principales","funcionalidades":"Funcionalidades principales",
    "h√°bitos":"H√°bitos financieros","historia y origen":"Historia y origen (Xavier Serbia)","origen e historia":"Historia y origen (Xavier Serbia)"
  };

  let FAQ = [];
  let catIndex = {};

  window.addEventListener('DOMContentLoaded', init);

  async function init(){
    Object.assign(els, {
      launcher: byId('launcher'), chat: byId('chatWindow'), body: byId('chatBody'),
      input: byId('userInput'), send: byId('sendBtn'), close: byId('closeBtn'),
      clear: byId('clearBtn'), email: byId('emailBtn')
    });

    // Abrir/cerrar
    els.launcher.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      toggle(true);
      setTimeout(()=>{ try{ els.input && els.input.focus(); }catch(_){} }, 50);
    });
    els.close.addEventListener('click', (e)=>{ e.preventDefault(); toggle(false); });

    // Enviar
    els.send.addEventListener('click', onSend);
    els.input.addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        const v=(els.input.value||'').trim();
        if(!v){ showTopics(); return; }
        onSend();
      }
    });

    // Toolbar
    els.clear.addEventListener('click', clearChat);
    els.email.addEventListener('click', ()=> window.location.href = buildSupportEmail());

    // Delegaci√≥n de clics (temas y acorde√≥n)
    els.chat.addEventListener('click', (e)=>{
      const t = e.target.closest('.topic-btn');
      if(t){ showCategoryPanel(t.getAttribute('data-cat')); return; }
      const q = e.target.closest('[data-toggle="qa"]');
      if(q){
        const id=q.getAttribute('data-id');
        const ans=els.chat.querySelector('.ans[data-id="'+id+'"]');
        if(ans) ans.classList.toggle('open');
      }
    });

    // Cargar JSON (si falla, seguimos con 0 items)
    try{
      const res = await fetch('./faq_cadamenudo.json?v=10', {cache:'no-store'});
      FAQ = await res.json();
    }catch(e){ FAQ = []; }

    buildCategoryIndex();

    // Bienvenida
    els.body.innerHTML='';
    pushHTML('bot','üëã Hola, soy <b>Chin Chin</b>, tu chatbot de Cada Menudo. Toca un tema para empezar üëá<br><small>Tip: escribe <b>‚Äúlimpiar‚Äù</b> para reiniciar</small>');
    showTopics();
  }

  function toggle(open){
    if(!els.chat) return;
    els.chat.style.display = open ? 'grid' : 'none';
  }

  function buildCategoryIndex(){
    const buckets={}; CATEGORY_ORDER.forEach(c=>buckets[c]=[]);
    FAQ.forEach(it=>{
      let raw=(it.category||'').trim(); const n=norm(raw);
      if(CATEGORY_ALIASES[n]) raw=CATEGORY_ALIASES[n];
      const match = CATEGORY_ORDER.find(x=> norm(x)===norm(raw)) || "Funcionalidades principales";
      buckets[match].push({q:String(it.q||'').trim(), a:String(it.a||'').trim(), category:match, link:it.link});
    });
    catIndex=buckets;
  }

  function showTopics(){
    const html =
      '<div class="topic-grid">' +
        CATEGORY_ORDER.map(k=> '<button class="topic-btn" data-cat="'+escapeHtml(k)+'">'+escapeHtml(k)+'</button>').join('') +
      '</div>';
    pushHTML('bot', html);
  }

  function showCategoryPanel(cat){
    const seen=new Set();
    const items=(catIndex[cat]||[]).filter(it=>{
      const k=String(it.q||'').toLowerCase();
      if(seen.has(k)) return false;
      seen.add(k);
      return true;
    }).slice(0,40);

    const list = items.length
      ? '<div class="q-list">' + items.map((it,idx)=>{
          const id = norm(cat) + '-' + idx; /* sin backticks anidados */
          return (
            '<div class="q-item">'+
              '<button class="q-btn" data-toggle="qa" data-id="'+id+'">‚Ä¢ '+escapeHtml(it.q)+'</button>'+
              '<div class="ans" data-id="'+id+'"><div class="ans-inner">'+escapeHtml(it.a)+'</div></div>'+
            '</div>'
          );
        }).join('') + '</div>'
      : '<div class="q-empty">A√∫n no hay preguntas en este tema.</div>';

    const html =
      '<div class="cat-panel">'+
        '<div class="cat-title">Tema: '+escapeHtml(cat)+'</div>'+
        list+
      '</div>';

    pushHTML('bot', html);
  }

  /* B√∫squeda */
  function score(qTokens,item){
    const hay=(item.q+' '+item.category).toLowerCase();
    const set=new Set(tokenize(hay)); let s=0; qTokens.forEach(t=>{ if(set.has(t)) s++; });
    if(item.q.toLowerCase().includes(qTokens.join(' '))) s+=1.5;
    return s;
  }
  function searchFAQ(q){
    const t=tokenize(q);
    return FAQ.map(i=>({i,s:score(t,i)})).filter(x=>x.s>0).sort((a,b)=>b.s-a.s).map(x=>x.i);
  }

  function onSend(){
    const text=(els.input.value||'').trim(); if(!text) return;
    push('user', text); els.input.value='';

    if (/^(limpiar|borrar|reiniciar|reset)$/i.test(text)) { clearChat(); return; }
    if (/^(email|correo|soporte|contacto)$/i.test(text)) { window.location.href=buildSupportEmail(); push('bot','Abriendo correo para soporte‚Ä¶ ‚úâÔ∏è'); return; }

    const hitsRaw=searchFAQ(text), seen=new Set();
    const hits=hitsRaw.filter(it=>{ const k=(it.q||'').trim().toLowerCase(); if(seen.has(k)) return false; seen.add(k); return true; });
    if(hits.length){
      const html =
        '<div class="cat-panel">'+
          '<div class="cat-title">Resultados</div>'+
          '<div class="q-list">'+
            hits.slice(0,10).map((it,idx)=>{
              const id = 'search-' + idx; /* sin backticks anidados */
              return (
                '<div class="q-item">'+
                  '<button class="q-btn" data-toggle="qa" data-id="'+id+'">‚Ä¢ '+escapeHtml(it.q)+'</button>'+
                  '<div class="ans" data-id="'+id+'"><div class="ans-inner">'+escapeHtml(it.a)+'</div></div>'+
                '</div>'
              );
            }).join('')+
          '</div>'+
        '</div>';
      pushHTML('bot', html);
    }else{
      push('bot','No encontr√© una respuesta exacta. Toca un tema de la lista o escribe otra palabra clave.');
      showTopics();
    }
  }

  /* Render helpers */
  function push(role,text){ renderMsg(role,text,false,false); }
  function pushHTML(role,html){ renderMsg(role,html,false,true); }
  function renderMsg(role,text,skip,isHTML){
    const wrap=document.createElement('div'); wrap.className='msg '+role;
    const b=document.createElement('div'); b.className='bubble';
    if(isHTML) b.innerHTML=text; else b.innerHTML=escapeHtml(text).replace(/\n/g,'<br/>');
    const meta=document.createElement('span'); meta.className='meta';
    meta.textContent=(role==='bot'?'Asistente':'T√∫')+' ‚Ä¢ '+new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    b.appendChild(meta); wrap.appendChild(b); els.body.appendChild(wrap);
    if(!skip) els.body.scrollTop=els.body.scrollHeight;
  }

  function clearChat(){
    els.body.innerHTML='';
    pushHTML('bot','Conversaci√≥n limpiada. ¬øEn qu√© te ayudo ahora?');
    showTopics();
  }

  function buildSupportEmail(){
    const body='Hola equipo t√©cnico,%0D%0A%0D%0ANecesito ayuda con el chatbot de Cada Menudo.%0D%0A%0D%0ADescripci√≥n del problema:%0D%0A(Escribe aqu√≠‚Ä¶)%0D%0A%0D%0A---%0D%0AEnviado desde el chatbot de Cada Menudo.';
    return 'mailto:tech@cadamenudo.com?subject=Soporte%20Chatbot%20Cada%20Menudo&body='+body;
  }
})();
</script>
</body>
</html>
