<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chatbot ‚Äì Cada Menudo</title>

<!-- Tipograf√≠a Greycliff CF -->
<link rel="stylesheet" href="https://cadamenudo.github.io/UI-UX/css-fonts.css"/>

<style>
  :root{
    --primary:#3956E8;
    --secondary:#7459D9;
    --accent:#E8C239;
    --bg:#ffffff;
    --text:#0f172a;
    --muted:#64748B;
    --border:#E5E7EB;
    --card:#F8FAFC;
    --shadow:0 10px 30px rgba(15,23,42,.15);
  }
  *{box-sizing:border-box}
  html,body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:"Greycliff CF",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }

  /* === BOT√ìN FLOTANTE === */
  .chat-launcher{
    position:fixed; right:20px; bottom:20px;
    border:none; padding:0; cursor:pointer;
    width:68px; height:68px; border-radius:50%;
    background:linear-gradient(135deg,var(--primary),var(--secondary));
    box-shadow:var(--shadow); z-index:9999;
    display:grid; place-items:center;
  }
  .launcher-logo{
    width:58px; height:58px; border-radius:50%;
    object-fit:cover; background:#fff; padding:4px;
  }

  /* === VENTANA DEL CHAT === */
  .chat-window{
    position:fixed; right:20px; bottom:90px;
    width:360px; max-width:92vw; height:560px; max-height:80vh;
    background:#fff; border-radius:16px;
    box-shadow:var(--shadow);
    display:none; grid-template-rows:auto auto 1fr auto auto;
    overflow:hidden; z-index:9999;
    border:1px solid var(--border);
  }

  /* === HEADER === */
  .chat-header{
    display:flex; align-items:center; gap:12px;
    padding:14px 16px;
    background:linear-gradient(135deg,var(--primary),var(--secondary));
    color:#fff;
  }
  .bot-logo{
    width:36px; height:36px; border-radius:50%;
    object-fit:cover; background:#fff; padding:2px;
  }
  .chat-title{font-weight:700; color:#fff;}
  .chat-sub{font-size:12px; color:var(--accent); margin-top:-2px}
  .header-actions{margin-left:auto; display:flex; align-items:center; gap:10px;}
  .header-link{
    font-size:12px; color:#fff; text-decoration:none;
    border:1px solid rgba(255,255,255,.5);
    padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.15);
  }
  .header-link:hover{background:rgba(255,255,255,.3);}
  .close-btn{
    background:transparent; border:none; color:#fff;
    font-size:18px; cursor:pointer; padding:4px 6px;
  }

  /* === CHIPS Y BODY === */
  .chipbar{
    display:flex; gap:8px; padding:10px 12px;
    flex-wrap:wrap; border-bottom:1px solid var(--border);
    background:#fff;
  }
  .chip{
    border:1px solid var(--border);
    padding:6px 10px; border-radius:999px;
    font-size:12px; cursor:pointer; background:#fff;
  }

  .search-hint{font-size:12px;color:var(--muted);padding:0 16px 10px}
  .chat-body{padding:14px; overflow-y:auto; background:#fff}
  .msg{display:flex; margin:8px 0}
  .msg.bot{justify-content:flex-start}
  .msg.user{justify-content:flex-end}
  .bubble{
    max-width:75%; padding:10px 12px; border-radius:14px;
    font-size:14px; line-height:1.35; border:1px solid var(--border); background:#fff;
  }
  .msg.bot .bubble{background:#f5f7ff; border-color:#dfe4ff}
  .msg.user .bubble{background:#eef2ff; border-color:#dadaff}
  .meta{display:block; color:var(--muted); font-size:11px; margin-top:4px}

  .faq-suggest{border:1px dashed var(--border); padding:10px; border-radius:10px; background:#fff; margin:8px 0; font-size:13px}
  .faq-suggest a{color:var(--primary); text-decoration:none}
  .faq-item{padding:8px 10px; border:1px solid var(--border); border-radius:10px; margin:8px 0; background:#fff}
  .faq-item .q{font-weight:700; margin-bottom:6px}
  .faq-item .a{font-size:14px}

  /* === TOOLBAR === */
  .toolbar{
    display:flex; gap:8px; padding:8px 12px;
    border-top:1px dashed var(--border);
    background:#f9fafb; align-items:center; flex-wrap:wrap;
  }
  .tool{
    font-size:12px; color:var(--muted); cursor:pointer;
    border:1px solid var(--border); padding:6px 10px;
    border-radius:8px; background:#fff;
  }

  /* === FOOTER === */
  .chat-footer{border-top:1px solid var(--border); background:#fff; padding:8px;}
  .quick{display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 8px;}
  .quick button{
    border:1px solid var(--border); background:#fff;
    border-radius:999px; padding:6px 10px; font-size:12px; cursor:pointer;
  }
  .quick button:hover{background:#f2f4ff}
  .input-row{display:flex; gap:8px}
  .input-row input{
    flex:1; padding:10px 12px; border:1px solid var(--border);
    border-radius:12px; font-size:14px; outline:none;
  }
  .input-row button{
    padding:10px 12px; border:none; border-radius:12px;
    background:var(--primary); color:#fff; cursor:pointer; font-weight:600;
  }
  .input-row button:hover{background:var(--secondary)}

  /* === SCROLLBAR === */
  .chat-body::-webkit-scrollbar{width:10px}
  .chat-body::-webkit-scrollbar-thumb{background:#d9defa; border-radius:8px}

  /* === MODO OSCURO (autom√°tico) === */
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0b1020;
      --text:#f3f4f6;
      --muted:#9aa4b2;
      --border:#1f2937;
      --card:#0f172a;
      --shadow:0 10px 30px rgba(0,0,0,.45);
    }
    .chat-window{ background:#0f172a; border-color:#1f2937; }
    .chipbar, .chat-footer, .toolbar{ background:#0f172a; border-color:#1f2937; }
    .chip{ background:#111827; border-color:#1f2937; color:#e5e7eb; }
    .search-hint{ color:#9aa4b2; }
    .chat-body{ background:#0f172a; }
    .bubble{ background:#0b1326; border-color:#1f2937; color:#e5e7eb; }
    .msg.bot .bubble{ background:#0e1a33; border-color:#1f2937; }
    .msg.user .bubble{ background:#132043; border-color:#1f2937; }
    .faq-item{ background:#0b1326; border-color:#1f2937; }
    .faq-suggest a{ color:#9fb0ff; }
    .tool{ background:#0b1326; border-color:#1f2937; color:#cbd5e1; }
    .input-row input{ background:#0b1326; border-color:#1f2937; color:#e5e7eb; }
    .input-row button{ background:var(--primary); }
  }

  /* === M√ìVIL FULL SCREEN === */
  @media (max-width:480px){
    .chat-window{
      right:0; left:0; bottom:0; top:0;
      width:100vw; height:100vh; max-height:100vh; border-radius:0;
    }
    .launcher-logo{width:56px; height:56px;}
    .bot-logo{width:40px; height:40px;}
  }
</style>
</head>
<body>

<!-- Bot√≥n flotante con logo -->
<button class="chat-launcher" id="launcher" aria-label="Abrir chat">
  <img class="launcher-logo" src="https://cadamenudo.github.io/UI-UX/isotopo%20w-name.png" alt="Cada Menudo"/>
</button>

<!-- Ventana de chat -->
<section class="chat-window" id="chatWindow" aria-live="polite">
  <header class="chat-header">
    <img class="bot-logo" src="https://cadamenudo.github.io/UI-UX/isotopo%20w-name.png" alt="Cada Menudo"/>
    <div>
      <div class="chat-title">ChinChin Bot</div>
      <div class="chat-sub">Preguntas frecuentes ‚Ä¢ Soporte</div>
    </div>

    <div class="header-actions">
      <a class="header-link" href="/privacidad.html" target="_blank" rel="noopener">Privacidad</a>
      <button id="closeBtn" class="close-btn" aria-label="Cerrar">‚úï</button>
    </div>
  </header>

  <!-- Chips de categor√≠as (se llenan din√°micamente) -->
  <div class="chipbar" id="chipbar"></div>

  <!-- Hint -->
  <div class="search-hint" id="searchHint">
    Escribe tu pregunta o elige una categor√≠a. Ejemplos: ‚ÄúCuenta y registro‚Äù, ‚ÄúTransacciones‚Äù, ‚ÄúMetas‚Äù, ‚ÄúPlanes y precios‚Äù.
  </div>

  <!-- √Årea de mensajes -->
  <main class="chat-body" id="chatBody"></main>

  <!-- Barra de herramientas -->
  <div class="toolbar">
    <button class="tool" id="clearBtn" title="Borrar conversaci√≥n">üßπ Limpiar</button>
    <button class="tool" id="downloadBtn" title="Descargar conversaci√≥n (JSON)">‚¨áÔ∏è Descargar</button>
    <button class="tool" id="emailBtn" title="Enviar un email a soporte">üìß Enviar email a soporte</button>
  </div>

  <!-- Footer -->
  <footer class="chat-footer">
    <div class="quick" id="quickRow">
      <button data-q="Cuenta y registro">Cuenta y registro</button>
      <button data-q="Transacciones">Transacciones</button>
      <button data-q="Metas">Metas</button>
      <button data-q="Planes y precios">Planes y precios</button>
    </div>
    <div class="input-row">
      <input id="userInput" type="text" placeholder="Escribe tu pregunta‚Ä¶ (Enter para enviar)" autocomplete="off" />
      <button id="sendBtn">Enviar</button>
    </div>
  </footer>
</section>

<script>
(async function(){
  const els = {
    launcher: document.getElementById('launcher'),
    chat: document.getElementById('chatWindow'),
    body: document.getElementById('chatBody'),
    input: document.getElementById('userInput'),
    send: document.getElementById('sendBtn'),
    close: document.getElementById('closeBtn'),
    clear: document.getElementById('clearBtn'),
    download: document.getElementById('downloadBtn'),
    email: document.getElementById('emailBtn'),
    quick: document.getElementById('quickRow'),
    chipbar: document.getElementById('chipbar'),
    hint: document.getElementById('searchHint'),
  };

  const STORAGE_KEY = 'cm_chat_history_v4';

  /* === 1) Cargar FAQ desde JSON generado del Excel === */
  let FAQ = [];
  try{
    const res = await fetch('./faq_cadamenudo.json?v=1', { cache: 'no-store' });
    FAQ = await res.json();
  }catch(e){
    console.warn('No pude cargar faq_cadamenudo.json; usando arreglo vac√≠o.', e);
    FAQ = [];
  }

  /* === 2) Utilidades de normalizaci√≥n (para FIX de categor√≠as) === */
  const norm = (s) => (s==null?'':String(s)).trim().toLowerCase();
  const catIndex = {};
  FAQ.forEach(it=>{
    const c = norm(it.category);
    if(!c) return;
    if(!catIndex[c]) catIndex[c] = [];
    catIndex[c].push(it);
  });

  /* === 3) Intenciones b√°sicas === */
  const intents = [
    {name:'saludo', match:/(^|\s)(hola|buenas|hey|saludos)(\s|!|$)/i,
      reply:()=>"¬°Hola! ¬øEn qu√© te ayudo? Puedo responder sobre cuenta y registro, transacciones, metas, planes y m√°s."},
    {name:'privacidad', match:/(privacidad|privacy|datos|data)/i,
      reply:()=>'Puedes revisar nuestra pol√≠tica aqu√≠: <a href="/privacidad.html" target="_blank" rel="noopener">Privacidad</a>'},
    {name:'soporte', match:/(soporte|ayuda|contacto|email|correo)/i,
      reply:()=>'Si necesitas soporte t√©cnico, usa el bot√≥n ‚Äúüìß Enviar email a soporte‚Äù o escribe a <a href="mailto:tech@cadamenudo.com">tech@cadamenudo.com</a>.'},
  ];

  /* === 4) Estado / Historial === */
  const state = { history: [] };
  try{
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    state.history = saved;
    saved.forEach(m => renderMsg(m.role, m.text, m.ts, true));
  }catch(e){}

  /* === 5) Chips por categor√≠a (desde FAQ) === */
  const uniqueCats = [...new Set(FAQ.map(f => (f.category||'').trim()).filter(Boolean))];
  uniqueCats.forEach(cat=>{
    const b = document.createElement('button');
    b.className = 'chip';
    b.textContent = cat;
    b.dataset.cat = norm(cat); // clave normalizada
    b.addEventListener('click', (ev)=> suggestByCategory(ev.currentTarget.dataset.cat, cat));
    els.chipbar.appendChild(b);
  });

  /* === 6) Mensaje de bienvenida (primera vez) === */
  if(state.history.length === 0){
    push('bot', '¬°Hola! Soy tu asistente de Cada Menudo. Preg√∫ntame algo o elige una categor√≠a arriba.');
    if (FAQ.length) showTopFAQ();
  }

  /* === 7) Eventos UI === */
  els.launcher.addEventListener('click', () => toggle(true));
  els.close.addEventListener('click', () => toggle(false));

  els.send.addEventListener('click', onSend);
  els.input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ onSend(); }});

  els.clear.addEventListener('click', () => {
    state.history = [];
    persist();
    els.body.innerHTML = '';
    push('bot', 'Conversaci√≥n limpiada. ¬øEn qu√© te ayudo ahora?');
    if (FAQ.length) showTopFAQ();
  });

  els.download.addEventListener('click', () => {
    const blob = new Blob([JSON.stringify(state.history,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'chat-cada-menudo.json';
    a.click(); URL.revokeObjectURL(url);
  });

  els.email.addEventListener('click', () => {
    const mailto = buildSupportEmail();
    window.location.href = mailto;
  });

  els.quick.addEventListener('click', (e)=>{
    if(e.target.matches('button[data-q]')){
      els.input.value = e.target.dataset.q;
      onSend();
    }
  });

  function toggle(open){ els.chat.style.display = open ? 'grid' : 'none'; }

  function onSend(){
    const text = (els.input.value || '').trim();
    if(!text) return;
    push('user', text);
    els.input.value = '';
    handle(text);
  }

  function push(role, text){
    const m = { role, text, ts:new Date().toISOString() };
    state.history.push(m);
    renderMsg(role, text, m.ts);
    persist();
  }
  function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.history)); }

  function renderMsg(role, text, ts, skipScroll){
    const wrap = document.createElement('div');
    wrap.className = 'msg '+role;
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.innerHTML = escapeHtml(text).replace(/\n/g,'<br/>');
    const meta = document.createElement('span');
    meta.className = 'meta';
    const time = new Date(ts || Date.now()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    meta.textContent = role==='bot' ? `Asistente ‚Ä¢ ${time}` : `T√∫ ‚Ä¢ ${time}`;
    bubble.appendChild(meta);
    wrap.appendChild(bubble);
    els.body.appendChild(wrap);
    if(!skipScroll) els.body.scrollTop = els.body.scrollHeight;
  }
  function escapeHtml(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

  /* === 8) Manejo: Intenciones -> FAQ -> Fallback === */
  async function handle(text){
    // a) Intenciones
    for (const it of intents){
      if(it.match.test(text)){
        push('bot', it.reply());
        return;
      }
    }
    // b) FAQ
    const hits = searchFAQ(text);
    if(hits.length){
      const top = hits.slice(0,3);
      push('bot', renderFAQSuggestions(top));
      return;
    }
    // c) Fallback
    push('bot', 'No encontr√© una respuesta exacta. Intenta otra palabra clave o elige una categor√≠a arriba.');
  }

  function tokenize(s){
    return (s||'').toLowerCase()
      .normalize('NFD').replace(/\p{Diacritic}/gu,'')
      .replace(/[^a-z0-9√°√©√≠√≥√∫√±√º\s]/gi,' ')
      .split(/\s+/).filter(Boolean);
  }
  function score(queryTokens, item){
    const haystack = (item.q+' '+(item.tags||[]).join(' ')+' '+(item.category||'')).toLowerCase();
    const tks = new Set(tokenize(haystack));
    let s = 0;
    for(const qt of queryTokens){ if(tks.has(qt)) s += 1; }
    if(item.q.toLowerCase().includes(queryTokens.join(' '))) s += 1.5;
    return s;
  }
  function searchFAQ(query){
    const qTks = tokenize(query);
    const withScore = FAQ.map(item => ({item, s:score(qTks, item)}))
                         .filter(x => x.s>0)
                         .sort((a,b)=>b.s-a.s);
    return withScore.map(x=>x.item);
  }

  function renderFAQSuggestions(items){
    let html = 'Esto es lo que encontr√©:<div class="faq-suggest">';
    html += items.map(it =>
      `<div class="faq-item">
         <div class="q">‚Ä¢ ${escapeHtml(it.q)}</div>
         <div class="a">${it.a}${it.link?`<div style="margin-top:6px;"><a href="${it.link}" target="_blank" rel="noopener">Abrir</a></div>`:''}</div>
       </div>`
    ).join('');
    html += '</div>';
    return html;
  }

  /* === 9) FIX categor√≠as: b√∫squeda tolerante + fallback === */
  function suggestByCategory(catKey, originalLabel){
    const key = norm(catKey||originalLabel);
    let items = (catIndex[key]||[]).slice(0,6);

    // si no hubo coincidencia exacta, probar por inclusi√≥n en category, tags o pregunta
    if(items.length === 0){
      items = FAQ.filter(f =>
        norm(f.category).includes(key) ||
        (f.tags||[]).some(t => norm(t).includes(key)) ||
        norm(f.q).includes(key)
      ).slice(0,6);
    }

    // si a√∫n vac√≠o, usa el motor de b√∫squeda general como √∫ltimo recurso
    if(items.length === 0){
      items = searchFAQ(originalLabel||catKey).slice(0,6);
    }

    if(items.length){
      push('bot', `Categor√≠a: <b>${escapeHtml(originalLabel||catKey)}</b><br/>` + renderFAQSuggestions(items));
    } else {
      push('bot', `No tengo elementos en la categor√≠a <b>${escapeHtml(originalLabel||catKey)}</b> a√∫n.`);
    }
  }

  function showTopFAQ(){
    const top = FAQ.slice(0,3);
    if(top.length){
      push('bot', renderFAQSuggestions(top));
    }
  }

  /* === 10) Email a soporte (mailto) con contexto === */
  function buildSupportEmail(){
    const to = "tech@cadamenudo.com";
    const subject = encodeURIComponent("Soporte Chatbot ‚Äì Cada Menudo");
    const last = state.history.slice(-10).map(m => {
      const t = new Date(m.ts).toLocaleString();
      return `${m.role.toUpperCase()} [${t}]: ${m.text}`;
    }).join('\n');

    const ua = navigator.userAgent || '';
    const lang = navigator.language || '';
    const bodyText =
`Hola equipo t√©cnico,

Necesito ayuda con el chatbot de Cada Menudo.

Descripci√≥n del problema / pregunta:
(Escribe aqu√≠‚Ä¶)

Contexto (√∫ltimos mensajes):
${last}

Datos t√©cnicos:
- URL: ${location.href}
- Navegador: ${ua}
- Idioma: ${lang}

Gracias.`;

    const body = encodeURIComponent(bodyText);
    return `mailto:${to}?subject=${subject}&body=${body}`;
  }

  /* === 11) Comportamiento de apertura por defecto === */
  toggle(false);
})();
</script>
</body>
</html>
