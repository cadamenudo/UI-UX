<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chatbot ‚Äì Cada Menudo (Minimal)</title>
<link rel="stylesheet" href="https://cadamenudo.github.io/UI-UX/css-fonts.css"/>

<style>
  :root{
    --primary:#3956E8; --secondary:#7459D9; --accent:#E8C239;
    --bg:#ffffff; --text:#0d1320; --muted:#6b7280; --border:#E6E8F0; --shadow:0 8px 28px rgba(15,23,42,.12);
    --bot:#F3F6FF; --user:#F7F8FB;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:"Greycliff CF",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

  /* Bot√≥n flotante */
  .chat-launcher{
    position:fixed; right:20px; bottom:20px; width:64px; height:64px; border-radius:50%;
    border:none; background:var(--primary); color:#fff; display:grid; place-items:center;
    box-shadow:var(--shadow); cursor:pointer; z-index:9999;
  }
  .launcher-logo{
    width:38px; height:38px; border-radius:50%; background:#fff; padding:6px; object-fit:contain;
  }

  /* Ventana */
  .chat-window{
    position:fixed; right:20px; bottom:92px; width:360px; max-width:92vw; height:560px; max-height:78vh;
    display:none; grid-template-rows:auto auto auto 1fr auto auto;
    background:#fff; border-radius:18px; overflow:hidden; box-shadow:var(--shadow); z-index:9999; border:1px solid var(--border);
  }

  /* Header */
  .chat-header{ display:flex; align-items:center; gap:12px; padding:12px 14px; background:#fff; border-bottom:1px solid var(--border) }
  .bot-logo{ width:32px; height:32px; border-radius:50%; background:#fff; padding:4px; object-fit:contain }
  .chat-title{font-weight:700; color:var(--primary); line-height:1}
  .chat-sub{font-size:12px; color:var(--muted); margin-top:2px}
  .header-actions{margin-left:auto; display:flex; gap:8px; align-items:center}
  .icon-btn{ background:transparent; border:none; color:#94A3B8; font-size:18px; cursor:pointer; padding:6px }

  /* Input arriba */
  .input-top{ padding:10px 12px; border-bottom:1px solid var(--border); background:#fff }
  .input-row{ display:flex; gap:8px }
  .input-row input{ flex:1; padding:12px; border:1px solid var(--border); border-radius:12px; font-size:14px; outline:none; }
  .input-row input::placeholder{ color:#98A2B3; }
  .input-row button{ padding:12px 14px; border:none; border-radius:12px; background:var(--primary); color:#fff; font-weight:700; cursor:pointer }

  /* Categor√≠as */
  .chipbar{display:flex; gap:8px; padding:10px 12px; border-bottom:1px solid var(--border); background:#fff; overflow:auto}
  .chip{border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; background:#fff; color:#374151; white-space:nowrap}
  .chip:active{transform:scale(.98)}

  /* Cuerpo */
  .chat-body{padding:14px; overflow:auto; background:#fff}
  .msg{display:flex; margin:8px 0}
  .msg.bot{justify-content:flex-start}
  .msg.user{justify-content:flex-end}
  .bubble{ max-width:78%; padding:10px 12px; border-radius:14px; font-size:14px; line-height:1.35; border:1px solid var(--border) }
  .msg.bot .bubble{background:var(--bot)}
  .msg.user .bubble{background:var(--user)}
  .meta{display:block; color:#9AA4B2; font-size:11px; margin-top:4px}

  /* Sugerencias FAQ */
  .faq-suggest{border:1px dashed var(--border); padding:10px; border-radius:12px; background:#fff; margin:8px 0; font-size:13px}
  .faq-item{padding:8px 10px; border:1px solid var(--border); border-radius:10px; margin:8px 0; background:#fff}
  .faq-item .q{font-weight:700; margin-bottom:6px}
  .faq-item .a{font-size:14px}
  .faq-suggest a{color:var(--primary); text-decoration:none}

  /* Toolbar (oculta) */
  .toolbar{display:none; gap:8px; padding:8px 12px; border-top:1px dashed var(--border); background:#fff}
  .tool{font-size:12px; color:#374151; cursor:pointer; border:1px solid var(--border); padding:6px 10px; border-radius:8px; background:#fff}

  /* Footer discreto */
  .chat-footer{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 12px; border-top:1px solid var(--border); background:#fff }
  .privacy-link{ font-size:12px; color:#8A93A6; text-decoration:none }
  .privacy-link:hover{ color:#6B7280; text-decoration:underline }

  /* Dark mode */
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b1020; --text:#E5E7EB; --muted:#9aa4b2; --border:#1f2937; --bot:#0e1830; --user:#0b1326; }
    .chat-window{ background:#0f172a; border-color:var(--border) }
    .chat-header, .input-top, .chipbar, .chat-footer, .toolbar{ background:#0f172a; border-color:var(--border) }
    .chip, .tool{ background:#0b1326; border-color:var(--border); color:#e5e7eb }
    .faq-item{ background:#0b1326; border-color:var(--border) }
    .faq-suggest a{ color:#9fb0ff }
    .input-row input{ background:#0b1326; border-color:var(--border); color:#e5e7eb }
  }

  @media (max-width:480px){
    .chat-window{ right:0; left:0; bottom:0; top:0; width:100vw; height:100vh; max-height:100vh; border-radius:0 }
  }
</style>
</head>
<body>

<button class="chat-launcher" id="launcher" aria-label="Abrir chat">
  <img class="launcher-logo" src="https://cadamenudo.github.io/UI-UX/isotopo%20w-name.png" alt="Cada Menudo"/>
</button>

<section class="chat-window" id="chatWindow" aria-live="polite">
  <header class="chat-header">
    <img class="bot-logo" src="https://cadamenudo.github.io/UI-UX/isotopo%20w-name.png" alt="Cada Menudo"/>
    <div>
      <div class="chat-title">ChinChin Bot</div>
      <div class="chat-sub">Ayuda y preguntas frecuentes</div>
    </div>
    <div class="header-actions">
      <button id="closeBtn" class="icon-btn" aria-label="Cerrar">‚úï</button>
    </div>
  </header>

  <!-- INPUT ARRIBA -->
  <div class="input-top">
    <div class="input-row">
      <input id="userInput" type="text" placeholder="Pregunta" autocomplete="off"/>
      <button id="sendBtn" type="button">Enviar</button>
    </div>
  </div>

  <!-- Categor√≠as -->
  <div class="chipbar" id="chipbar"></div>

  <!-- Conversaci√≥n -->
  <main class="chat-body" id="chatBody"></main>

  <!-- Herramientas -->
  <div class="toolbar" id="toolbar">
    <button class="tool" id="clearBtn">üßπ Limpiar</button>
    <button class="tool" id="downloadBtn">‚¨áÔ∏è Descargar</button>
    <button class="tool" id="emailBtn">üìß Soporte</button>
  </div>

  <!-- Footer discreto -->
  <footer class="chat-footer">
    <a class="privacy-link" href="/privacidad.html" target="_blank" rel="noopener">Privacidad</a>
    <div style="font-size:12px; color:#8A93A6;">Cada Menudo</div>
  </footer>
</section>

<script>
(function(){
  const els = {};
  const STORAGE_KEY = 'cm_chat_history_minimal_v3';

  // Helpers
  function byId(id){ return document.getElementById(id); }
  function norm(s){ return (s==null?'':String(s)).trim().toLowerCase(); }
  function tokenize(s){
    // Quita tildes compatible con todos los navegadores
    return (s||'')
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g,'')  // <‚Äî en vez de \p{Diacritic}
      .replace(/[^a-z0-9√°√©√≠√≥√∫√±√º\s]/gi,' ')
      .split(/\s+/).filter(Boolean);
  }
  function escapeHtml(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

  // Estado
  const state = { history: [] };

  // Iniciar cuando DOM listo
  window.addEventListener('DOMContentLoaded', init, { once:true });

  async function init(){
    // Cache de elementos
    Object.assign(els, {
      launcher: byId('launcher'), chat: byId('chatWindow'), body: byId('chatBody'),
      input: byId('userInput'), send: byId('sendBtn'), close: byId('closeBtn'),
      clear: byId('clearBtn'), download: byId('downloadBtn'), email: byId('emailBtn'),
      chipbar: byId('chipbar'), toolbar: byId('toolbar')
    });

    // Abrir/cerrar
    els.launcher?.addEventListener('click', () => toggle(true));
    els.close?.addEventListener('click', () => toggle(false));

    // Enviar
    els.send?.addEventListener('click', onSendSafe);
    els.input?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') onSendSafe(); });

    // Herramientas
    els.clear?.addEventListener('click', () => {
      state.history=[]; persist(); els.body.innerHTML='';
      push('bot','Conversaci√≥n limpiada. ¬øEn qu√© te ayudo ahora?');
      if(FAQ.length) showTopFAQ();
    });
    els.download?.addEventListener('click', () => {
      const blob=new Blob([JSON.stringify(state.history,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download='chat-cada-menudo.json'; a.click(); URL.revokeObjectURL(url);
    });
    els.email?.addEventListener('click', () => { location.href = buildSupportEmail(); });

    // Cargar FAQ (con tolerancia a errores)
    let FAQ_raw = [];
    try{
      const res = await fetch('./faq_cadamenudo.json?v=4', { cache:'no-store' });
      FAQ_raw = await res.json();
    }catch(e){ console.warn('No pude cargar faq_cadamenudo.json', e); }
    window.FAQ = Array.isArray(FAQ_raw) ? FAQ_raw : [];

    // √çndice de categor√≠as
    window.catIndex = {};
    FAQ.forEach(it => { const c=norm(it.category); if(!c) return; (catIndex[c]??=[]).push(it); });

    // Render chips
    [...new Set(FAQ.map(f => (f.category||'').trim()).filter(Boolean))].forEach(cat=>{
      const b=document.createElement('button'); b.className='chip'; b.textContent=cat; b.dataset.cat=norm(cat);
      b.setAttribute('role','button');
      b.onclick=()=>suggestByCategory(b.dataset.cat, cat);
      els.chipbar.appendChild(b);
    });

    // Historial
    try{
      const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
      state.history = Array.isArray(saved) ? saved : [];
      state.history.forEach(m=>renderMsg(m.role,m.text,m.ts,true));
    }catch(_){}

    if(state.history.length===0){
      // Bienvenida personalizada que pediste
      push('bot','üëã Hola, soy <b>Chin Chin</b>, tu chatbot de Cada Menudo. Aqu√≠ te pongo los temas que pueden interesarte üëá');
      if(FAQ.length) showTopFAQ();
    }
  }

  // Manejo env√≠o con seguridad
  function onSendSafe(){
    try{
      const text = (els.input?.value || '').trim();
      if(!text) return;
      push('user', text);
      els.input.value = '';
      handle(text);
    }catch(err){
      console.error(err);
      push('bot', 'Ups, tuve un problema procesando tu mensaje. Intenta de nuevo por favor.');
    }
  }

  // Core chat
  function toggle(open){ if(els.chat) els.chat.style.display = open ? 'grid' : 'none'; }
  function push(role, text){
    const m = { role, text, ts:new Date().toISOString() };
    state.history.push(m);
    renderMsg(role, text, m.ts);
    persist();
  }
  function persist(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.history)); }catch(_){ } }
  function renderMsg(role, text, ts, skip){
    const wrap=document.createElement('div'); wrap.className='msg '+role;
    const b=document.createElement('div'); b.className='bubble'; b.innerHTML=escapeHtml(text).replace(/\n/g,'<br/>');
    const meta=document.createElement('span'); meta.className='meta';
    meta.textContent=(role==='bot'?'Asistente':'T√∫')+' ‚Ä¢ '+new Date(ts||Date.now()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    b.appendChild(meta); wrap.appendChild(b); els.body.appendChild(wrap);
    if(!skip) els.body.scrollTop = els.body.scrollHeight;
  }

  // B√∫squeda FAQ
  function score(qTokens,item){
    const hay=(item.q+' '+(item.tags||[]).join(' ')+' '+(item.category||'')).toLowerCase();
    const set=new Set(tokenize(hay));
    let s=0; for(const t of qTokens){ if(set.has(t)) s+=1; }
    if(item.q.toLowerCase().includes(qTokens.join(' '))) s+=1.5;
    return s;
  }
  function searchFAQ(q){
    const t = tokenize(q);
    return FAQ.map(i=>({i,s:score(t,i)}))
              .filter(x=>x.s>0)
              .sort((a,b)=>b.s-a.s)
              .map(x=>x.i);
  }
  function renderFAQ(items){
    return 'Encontr√© esto:<div class="faq-suggest">' +
      items.map(it=>`<div class="faq-item"><div class="q">‚Ä¢ ${escapeHtml(it.q)}</div><div class="a">${it.a}${it.link?`<div style="margin-top:6px;"><a href="${it.link}" target="_blank" rel="noopener">Abrir</a></div>`:''}</div></div>`).join('') +
      '</div>';
  }

  function suggestByCategory(key,label){
    const k=norm(key||label);
    let items=(catIndex[k]||[]).slice(0,6);
    if(items.length===0){
      items=FAQ.filter(f=>norm(f.category).includes(k) || (f.tags||[]).some(t=>norm(t).includes(k)) || norm(f.q).includes(k)).slice(0,6);
    }
    if(items.length===0){ items=searchFAQ(label||key).slice(0,6); }
    if(items.length) push('bot', `Categor√≠a: <b>${escapeHtml(label||key)}</b><br/>`+renderFAQ(items));
    else push('bot', `No tengo elementos en la categor√≠a <b>${escapeHtml(label||key)}</b> a√∫n.`);
  }

  function showTopFAQ(){
    const cats = [...new Set(FAQ.map(f=>f.category).filter(Boolean))].slice(0,6);
    if(cats.length){
      const html = cats.map(cat=>`<div class="faq-item" style="border:none;padding:6px 0;">
        <div style="color:#3956E8;font-weight:600;">‚Ä¢ ${escapeHtml(cat)}</div>
      </div>`).join('');
      push('bot', `<div class="faq-suggest">${html}</div>`);
    }
    const top = FAQ.slice(0,3);
    if(top.length) push('bot', renderFAQ(top));
  }

  function buildSupportEmail(){
    const last=state.history.slice(-10).map(m=>`${m.role.toUpperCase()} [${new Date(m.ts).toLocaleString()}]: ${m.text}`).join('\n');
    const ua=navigator.userAgent||'', lang=navigator.language||'';
    const body=`Hola equipo t√©cnico,

Necesito ayuda con el chatbot de Cada Menudo.

Descripci√≥n del problema / pregunta:
(Escribe aqu√≠‚Ä¶)

Contexto (√∫ltimos mensajes):
${last}

Datos t√©cnicos:
- URL: ${location.href}
- Navegador: ${ua}
- Idioma: ${lang}

Gracias.`;
    return `mailto:tech@cadamenudo.com?subject=${encodeURIComponent('Soporte Chatbot ‚Äì Cada Menudo')}&body=${encodeURIComponent(body)}`;
  }

  // Ajuste autom√°tico del logo (no se deforma)
  document.querySelectorAll('.launcher-logo, .bot-logo').forEach(img=>{
    img.addEventListener('load', ()=>{
      const {naturalWidth:w,naturalHeight:h}=img; if(!w||!h) return;
      const r=w/h; img.style.objectFit='contain'; img.style.background='#fff'; img.style.borderRadius='50%';
      img.style.padding = r>1.3 ? '8px' : r<0.8 ? '4px' : '5px';
    });
  });
})();
</script>
</body>
</html>
