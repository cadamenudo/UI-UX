<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chatbot ‚Äì Cada Menudo</title>
<link rel="stylesheet" href="https://cadamenudo.github.io/UI-UX/css-fonts.css"/>
<style>
  :root{
    --primary:#3956E8; --secondary:#7459D9; --accent:#E8C239;
    --bg:#ffffff; --text:#0f172a; --muted:#64748B; --border:#E5E7EB;
    --card:#F8FAFC; --shadow:0 10px 30px rgba(15,23,42,.15);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:"Greycliff CF",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  /* Bot√≥n flotante */
  .chat-launcher{
    position:fixed; right:20px; bottom:20px; width:60px; height:60px; border-radius:50%;
    background:linear-gradient(135deg,var(--primary),var(--secondary)); color:#fff; border:none;
    display:grid; place-items:center; box-shadow:var(--shadow); cursor:pointer; z-index:9999;
  }
  .chat-launcher span{font-size:26px; line-height:1}
  /* Ventana */
  .chat-window{
    position:fixed; right:20px; bottom:90px; width:360px; max-width:92vw; height:520px; max-height:80vh;
    background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow);
    display:none; grid-template-rows:auto 1fr auto; overflow:hidden; z-index:9999;
  }
  .chat-header{
    display:flex; align-items:center; gap:12px; padding:12px 16px; background:var(--card); border-bottom:1px solid var(--border);
  }
  .bot-avatar{
    width:32px; height:32px; border-radius:50%; background:linear-gradient(135deg,var(--primary),var(--secondary));
    display:grid; place-items:center; color:#fff; font-weight:700;
  }
  .chat-title{font-weight:700}
  .chat-sub{font-size:12px; color:var(--muted); margin-top:-2px}
  .chipbar{display:flex; gap:8px; padding:10px 12px; flex-wrap:wrap; border-bottom:1px solid var(--border); background:#fff}
  .chip{border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer; background:#fff}
  .chat-body{padding:14px; overflow-y:auto; background:#fff}
  .msg{display:flex; margin:8px 0}
  .msg.bot{justify-content:flex-start}
  .msg.user{justify-content:flex-end}
  .bubble{
    max-width:75%; padding:10px 12px; border-radius:14px; font-size:14px; line-height:1.35;
    border:1px solid var(--border); background:#fff;
  }
  .msg.bot .bubble{background:#f5f7ff; border-color:#dfe4ff}
  .msg.user .bubble{background:#eef2ff; border-color:#dadaff}
  .meta{display:block; color:var(--muted); font-size:11px; margin-top:4px}
  .quick{display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 2px;}
  .quick button{border:1px solid var(--border); background:#fff; border-radius:999px; padding:6px 10px; font-size:12px; cursor:pointer;}
  .chat-footer{border-top:1px solid var(--border); background:#fff; padding:8px;}
  .input-row{display:flex; gap:8px}
  .input-row input{flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:12px; font-size:14px; outline:none;}
  .input-row button{padding:10px 12px; border:none; border-radius:12px; background:var(--primary); color:#fff; cursor:pointer; font-weight:600;}
  .toolbar{display:flex; gap:8px; padding:8px 12px; border-top:1px dashed var(--border); background:#fafafa;}
  .tool{font-size:12px; color:var(--muted); cursor:pointer; border:1px solid var(--border); padding:4px 8px; border-radius:8px; background:#fff}
  .hidden{display:none}
  .search-hint{font-size:12px;color:var(--muted);padding:0 16px 10px}
  .faq-suggest{border:1px dashed var(--border); padding:10px; border-radius:10px; background:#fff; margin:8px 0; font-size:13px}
  .faq-suggest a{color:var(--primary); text-decoration:none}
  .faq-item{padding:8px 10px; border:1px solid var(--border); border-radius:10px; margin:8px 0; background:#fff}
  .faq-item .q{font-weight:700; margin-bottom:6px}
  .faq-item .a{font-size:14px}
  /* Scrollbar sutil */
  .chat-body::-webkit-scrollbar{width:10px}
  .chat-body::-webkit-scrollbar-thumb{background:#d9defa; border-radius:8px}
  /* Modo m√≥vil: full screen */
  @media (max-width:480px){
    .chat-window{right:0; left:0; bottom:0; top:0; width:100vw; height:100vh; max-height:100vh; border-radius:0;}
  }
</style>
</head>
<body>
<button class="chat-launcher" id="launcher" aria-label="Abrir chat"><span>üí¨</span></button>

<section class="chat-window" id="chatWindow" aria-live="polite">
  <header class="chat-header">
    <div class="bot-avatar">CM</div>
    <div>
      <div class="chat-title">Asistente Cada Menudo</div>
      <div class="chat-sub">Finanzas personales ‚Ä¢ Emprendimiento</div>
    </div>
    <button id="closeBtn" aria-label="Cerrar" style="margin-left:auto;background:transparent;border:none;font-size:18px;cursor:pointer;">‚úï</button>
  </header>

  <div class="chipbar" id="chipbar">
    <!-- Chips de categor√≠as (auto desde FAQ) -->
  </div>

  <div class="search-hint" id="searchHint">Escribe tu pregunta o elige una categor√≠a. Tengo respuestas r√°pidas en ‚ÄúReserva‚Äù, ‚ÄúDTI casa‚Äù, ‚ÄúRetiro‚Äù, ‚ÄúPresupuesto‚Äù.</div>
  <main class="chat-body" id="chatBody"></main>

  <div class="toolbar">
    <button class="tool" id="clearBtn" title="Borrar conversaci√≥n">üßπ Limpiar</button>
    <button class="tool" id="downloadBtn" title="Descargar JSON">‚¨áÔ∏è Descargar</button>
  </div>

  <footer class="chat-footer">
    <div class="quick" id="quickRow">
      <button data-q="Reserva de emergencia">Reserva de emergencia</button>
      <button data-q="DTI compra casa">DTI compra casa</button>
      <button data-q="Retiro">Retiro</button>
      <button data-q="Presupuesto">Presupuesto</button>
    </div>
    <div class="input-row">
      <input id="userInput" type="text" placeholder="Escribe tu pregunta‚Ä¶ (Enter para enviar)" autocomplete="off" />
      <button id="sendBtn">Enviar</button>
    </div>
  </footer>
</section>

<script>
(function(){
  const els = {
    launcher: document.getElementById('launcher'),
    chat: document.getElementById('chatWindow'),
    body: document.getElementById('chatBody'),
    input: document.getElementById('userInput'),
    send: document.getElementById('sendBtn'),
    close: document.getElementById('closeBtn'),
    clear: document.getElementById('clearBtn'),
    download: document.getElementById('downloadBtn'),
    quick: document.getElementById('quickRow'),
    chipbar: document.getElementById('chipbar'),
    hint: document.getElementById('searchHint'),
  };

  const STORAGE_KEY = 'cm_chat_history_v2';

  /* =======================
     1) TU BASE DE FAQ AQU√ç
     ======================= */
  const FAQ = [
    {
      category:"Reserva",
      q:"¬øC√≥mo calculo mi reserva de emergencia?",
      tags:["reserva","emergencia","fondo de contingencia","emergency fund"],
      a:"Define tus <b>gastos esenciales mensuales</b> y elige una meta (9, 12, 18 o 24 meses). Compara con tu efectivo/equivalentes. Si tienes super√°vit, reasigna a deudas, inversi√≥n o seguros.",
      link:"/calc/reserva"
    },
    {
      category:"Compra de casa",
      q:"¬øCu√°l es el DTI recomendado para comprar casa?",
      tags:["dti","hipoteca","compra casa","deuda ingreso"],
      a:"Usamos <b>DTI ‚â§ 36%</b> (sobre ingreso neto) y <b>Deuda/Activos ‚â§ 50%</b>. Si superas uno, no es recomendable. Usa nuestra calculadora para simular.",
      link:"/calc/compra-casa"
    },
    {
      category:"Retiro",
      q:"¬øC√≥mo estimo el capital necesario para retiro?",
      tags:["retiro","jubilaci√≥n","pensi√≥n","retirement"],
      a:"Partimos de tu edad, % de reemplazo, inflaci√≥n y tasa de rendimiento. Calculamos capital objetivo y aportes recomendados. Incluye Monte Carlo en la versi√≥n avanzada.",
      link:"/calc/retiro"
    },
    {
      category:"Presupuesto",
      q:"¬øCu√°l es una tasa de ahorro saludable?",
      tags:["presupuesto","ahorro","budget","tasa de ahorro"],
      a:"Benchmark recomendado: <b>‚â• 30%</b> √≥ptimo; 15‚Äì29% aceptable; &lt;15% no aceptable. Te ayudamos a identificar rubros para optimizar.",
      link:"/calc/presupuesto"
    },
    // üëâ Pega aqu√≠ tus preguntas comunes (de tu Excel/CSV) con este mismo formato.
  ];

  /* =========================
     2) ENDPOINT OPCIONAL (IA)
     ========================= */
  const ENDPOINT = ""; // p.ej. "https://api.tu-dominio.com/llm"

  // Intenciones r√°pidas (reglas)
  const intents = [
    {name:'saludo', match:/(hola|buenas|hey|saludos)/i,
      reply:()=>"¬°Hola! Puedo ayudarte con <b>reserva</b>, <b>DTI casa</b>, <b>retiro</b> o <b>presupuesto</b>. ¬øQu√© necesitas?"},
    {name:'reserva', match:/(reserva.*emerg|emergency fund|fondo de contingencia)/i,
      reply:()=>"Para calcular tu <b>reserva</b>: 1) gastos esenciales mensuales; 2) meta de 9/12/18/24 meses; 3) compara contra efectivo/equivalentes. <a href='/calc/reserva'>Abrir calculadora</a>"},
    {name:'dti', match:/(dti|compra.*casa|hipoteca|deuda.*ingreso)/i,
      reply:()=>"Para <b>compra de casa</b>: DTI ‚â§ 36% e √≠ndice Deuda/Activos ‚â§ 50%. <a href='/calc/compra-casa'>Abrir calculadora</a>"},
    {name:'retiro', match:/(retiro|jubil|pensi√≥n|retirement)/i,
      reply:()=>"Estimamos capital objetivo, aportes y probabilidad de √©xito. <a href='/calc/retiro'>Abrir calculadora</a>"},
    {name:'presupuesto', match:/(presupuesto|budget|ingresos.*gastos)/i,
      reply:()=>"Armamos un <b>presupuesto</b> por categor√≠as y meta de ahorro ‚â• 30%. <a href='/calc/presupuesto'>Abrir</a>"},
  ];

  // Estado e historial
  const state = { history: [] };

  // Cargar historial guardado
  try{
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    state.history = saved;
    saved.forEach(m => renderMsg(m.role, m.text, m.ts, true));
  }catch(e){}

  // Chips de categor√≠as (desde FAQ)
  const categories = [...new Set(FAQ.map(f => f.category).filter(Boolean))];
  categories.forEach(cat=>{
    const b = document.createElement('button');
    b.className = 'chip';
    b.textContent = cat;
    b.addEventListener('click', ()=> suggestByCategory(cat));
    els.chipbar.appendChild(b);
  });

  // Mensaje de bienvenida si no hay historial
  if(state.history.length === 0){
    push('bot', '¬°Hola! Soy tu asistente de Cada Menudo. Preg√∫ntame algo o elige una categor√≠a arriba. Tambi√©n puedes abrir nuestras calculadoras con los botones r√°pidos. üëá');
    // Mostrar sugerencias iniciales del FAQ
    showTopFAQ();
  }

  // Eventos UI
  els.launcher.addEventListener('click', () => toggle(true));
  els.close.addEventListener('click', () => toggle(false));
  els.send.addEventListener('click', onSend);
  els.input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ onSend(); }});
  els.clear.addEventListener('click', () => {
    state.history = [];
    persist();
    els.body.innerHTML = '';
    push('bot', 'Conversaci√≥n limpiada. ¬øEn qu√© te ayudo ahora?');
    showTopFAQ();
  });
  els.download.addEventListener('click', () => {
    const blob = new Blob([JSON.stringify(state.history,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'chat-cada-menudo.json';
    a.click(); URL.revokeObjectURL(url);
  });
  els.quick.addEventListener('click', (e)=>{
    if(e.target.matches('button[data-q]')){
      els.input.value = e.target.dataset.q;
      onSend();
    }
  });

  function toggle(open){ els.chat.style.display = open ? 'grid' : 'none'; }

  function onSend(){
    const text = (els.input.value || '').trim();
    if(!text) return;
    push('user', text);
    els.input.value = '';
    handle(text);
  }

  function push(role, text){
    const m = { role, text, ts:new Date().toISOString() };
    state.history.push(m);
    renderMsg(role, text, m.ts);
    persist();
  }
  function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.history)); }

  function renderMsg(role, text, ts, skipScroll){
    const wrap = document.createElement('div');
    wrap.className = 'msg '+role;
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.innerHTML = escapeHtml(text).replace(/\n/g,'<br/>');
    const meta = document.createElement('span');
    meta.className = 'meta';
    const time = new Date(ts || Date.now()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    meta.textContent = role==='bot' ? `Asistente ‚Ä¢ ${time}` : `T√∫ ‚Ä¢ ${time}`;
    bubble.appendChild(meta);
    wrap.appendChild(bubble);
    els.body.appendChild(wrap);
    if(!skipScroll) els.body.scrollTop = els.body.scrollHeight;
  }
  function escapeHtml(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

  /* ===========================
     B√öSQUEDA EN FAQ + INTENCIONES
     =========================== */
  async function handle(text){
    // 1) intent rules
    for (const it of intents){
      if(it.match.test(text)){
        push('bot', it.reply());
        return;
      }
    }
    // 2) buscar en FAQ
    const hits = searchFAQ(text);
    if(hits.length){
      const top = hits.slice(0,3);
      push('bot', renderFAQSuggestions(top));
      return;
    }
    // 3) fallback (opcional) a API
    if(ENDPOINT){
      try{
        const res = await fetch(ENDPOINT, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message:text })
        });
        const data = await res.json();
        if(data && data.reply){ push('bot', String(data.reply)); return; }
      }catch(e){}
    }
    // 4) Fallback local
    push('bot', 'No encontr√© una respuesta exacta. ¬øQuieres intentar con otra palabra o abrir una de las calculadoras?');
  }

  function tokenize(s){
    return (s||'').toLowerCase()
      .normalize('NFD').replace(/\p{Diacritic}/gu,'')
      .replace(/[^a-z0-9√°√©√≠√≥√∫√±√º\s]/gi,' ')
      .split(/\s+/).filter(Boolean);
  }

  function score(queryTokens, item){
    const haystack = (item.q+' '+(item.tags||[]).join(' ')+' '+(item.category||'')).toLowerCase();
    const tks = new Set(tokenize(haystack));
    let s = 0;
    for(const qt of queryTokens){ if(tks.has(qt)) s += 1; }
    // bonus por coincidencia de frase parcial en la pregunta
    if(item.q.toLowerCase().includes(queryTokens.join(' '))) s += 1.5;
    return s;
  }

  function searchFAQ(query){
    const qTks = tokenize(query);
    const withScore = FAQ.map(item => ({item, s:score(qTks, item)}))
                         .filter(x => x.s>0)
                         .sort((a,b)=>b.s-a.s);
    return withScore.map(x=>x.item);
  }

  function renderFAQSuggestions(items){
    let html = 'Encontr√© esto en nuestras gu√≠as:<div class="faq-suggest">';
    html += items.map(it =>
      `<div class="faq-item">
         <div class="q">‚Ä¢ ${escapeHtml(it.q)}</div>
         <div class="a">${it.a}${it.link?`<div style="margin-top:6px;"><a href="${it.link}">Abrir herramienta</a></div>`:''}</div>
       </div>`
    ).join('');
    html += '</div>';
    return html;
  }

  function suggestByCategory(cat){
    const items = FAQ.filter(f => f.category===cat).slice(0,5);
    if(items.length){
      push('bot', `Categor√≠a: <b>${escapeHtml(cat)}</b><br/>` + renderFAQSuggestions(items));
    } else {
      push('bot', `No tengo elementos en la categor√≠a <b>${escapeHtml(cat)}</b> a√∫n.`);
    }
  }

  function showTopFAQ(){
    const top = FAQ.slice(0,3);
    if(top.length){
      push('bot', renderFAQSuggestions(top));
    }
  }

  // Abrir cerrado seg√∫n √∫ltima interacci√≥n
  toggle(false);
})();
</script>
</body>
</html>
