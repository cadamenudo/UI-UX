<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chatbot ‚Äì Cada Menudo (Minimal)</title>
<link rel="stylesheet" href="https://cadamenudo.github.io/UI-UX/css-fonts.css"/>

<style>
  :root{
    --primary:#3956E8; --secondary:#7459D9; --accent:#E8C239;
    --bg:#ffffff; --text:#0d1320; --muted:#6b7280; --border:#E6E8F0; --shadow:0 8px 28px rgba(15,23,42,.12);
    --bot:#F3F6FF; --user:#F7F8FB;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:"Greycliff CF",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

  /* Bot√≥n flotante: azul s√≥lido, isotipo blanco centrado */
  .chat-launcher{
    position:fixed; right:20px; bottom:20px; width:64px; height:64px; border-radius:50%;
    border:none; background:var(--primary); color:#fff; display:grid; place-items:center;
    box-shadow:var(--shadow); cursor:pointer; z-index:9999;
  }
  .launcher-logo{
    width:38px; height:38px; border-radius:50%; background:#fff; padding:6px; object-fit:contain;
  }

  /* Ventana */
  .chat-window{
    position:fixed; right:20px; bottom:92px; width:360px; max-width:92vw; height:540px; max-height:78vh;
    display:none; grid-template-rows:auto auto 1fr auto; background:#fff; border-radius:18px; overflow:hidden;
    box-shadow:var(--shadow); z-index:9999; border:1px solid var(--border);
  }

  /* Header minimal: blanco, solo isotipo + texto + acciones sutiles */
  .chat-header{
    display:flex; align-items:center; gap:12px; padding:12px 14px; background:#fff; border-bottom:1px solid var(--border);
  }
  .bot-logo{ width:32px; height:32px; border-radius:50%; background:#fff; padding:4px; object-fit:contain; }
  .chat-title{font-weight:700; color:var(--primary); line-height:1}
  .chat-sub{font-size:12px; color:var(--muted); margin-top:2px}
  .header-actions{margin-left:auto; display:flex; gap:8px; align-items:center}
  .soft-btn{
    font-size:12px; color:var(--primary); background:#fff; border:1px solid var(--border); padding:6px 10px;
    border-radius:999px; cursor:pointer;
  }
  .icon-btn{ background:transparent; border:none; color:#94A3B8; font-size:18px; cursor:pointer; padding:6px; }

  /* Chips y hint */
  .chipbar{display:flex; gap:8px; padding:10px 12px; border-bottom:1px solid var(--border); background:#fff; overflow:auto;}
  .chip{border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; background:#fff; color:#374151; white-space:nowrap;}
  .chip:active{transform:scale(.98)}

  /* Cuerpo de chat */
  .chat-body{padding:14px; overflow:auto; background:#fff}
  .msg{display:flex; margin:8px 0}
  .msg.bot{justify-content:flex-start}
  .msg.user{justify-content:flex-end}
  .bubble{
    max-width:78%; padding:10px 12px; border-radius:14px; font-size:14px; line-height:1.35; border:1px solid var(--border);
  }
  .msg.bot .bubble{background:var(--bot)}
  .msg.user .bubble{background:var(--user)}
  .meta{display:block; color:#9AA4B2; font-size:11px; margin-top:4px}

  /* Sugerencias FAQ dentro del chat */
  .faq-suggest{border:1px dashed var(--border); padding:10px; border-radius:12px; background:#fff; margin:8px 0; font-size:13px}
  .faq-item{padding:8px 10px; border:1px solid var(--border); border-radius:10px; margin:8px 0; background:#fff}
  .faq-item .q{font-weight:700; margin-bottom:6px}
  .faq-item .a{font-size:14px}
  .faq-suggest a{color:var(--primary); text-decoration:none}

  /* Footer minimal */
  .chat-footer{border-top:1px solid var(--border); background:#fff; padding:10px}
  .quick{display:flex; gap:8px; flex-wrap:wrap; margin:0 0 8px}
  .quick button{border:1px solid var(--border); background:#fff; border-radius:999px; padding:6px 10px; font-size:12px; color:#374151; cursor:pointer}
  .input-row{display:flex; gap:8px}
  .input-row input{flex:1; padding:12px; border:1px solid var(--border); border-radius:12px; font-size:14px; outline:none}
  .input-row button{padding:12px 14px; border:none; border-radius:12px; background:var(--primary); color:#fff; font-weight:700; cursor:pointer}

  /* Toolbar colapsable (menos ruido) */
  .toolbar{display:none; gap:8px; padding:8px 12px; border-top:1px dashed var(--border); background:#fff}
  .tool{font-size:12px; color:#374151; cursor:pointer; border:1px solid var(--border); padding:6px 10px; border-radius:8px; background:#fff}

  /* Dark mode autom√°tico */
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b1020; --text:#E5E7EB; --muted:#9aa4b2; --border:#1f2937; --bot:#0e1830; --user:#0b1326; }
    .chat-window{ background:#0f172a; border-color:var(--border) }
    .chat-header, .chipbar, .chat-footer, .toolbar{ background:#0f172a; border-color:var(--border) }
    .chip, .quick button, .input-row input, .tool{ background:#0b1326; border-color:var(--border); color:#e5e7eb }
    .faq-item{ background:#0b1326; border-color:var(--border) }
    .faq-suggest a{ color:#9fb0ff }
  }

  @media (max-width:480px){
    .chat-window{ right:0; left:0; bottom:0; top:0; width:100vw; height:100vh; max-height:100vh; border-radius:0; }
  }
</style>
</head>
<body>

<button class="chat-launcher" id="launcher" aria-label="Abrir chat">
  <img class="launcher-logo" src="https://cadamenudo.github.io/UI-UX/isotopo%20w-name.png" alt="Cada Menudo"/>
</button>

<section class="chat-window" id="chatWindow" aria-live="polite">
  <header class="chat-header">
    <img class="bot-logo" src="https://cadamenudo.github.io/UI-UX/isotopo%20w-name.png" alt="Cada Menudo"/>
    <div>
      <div class="chat-title">ChinChin Bot</div>
      <div class="chat-sub">Ayuda y preguntas frecuentes</div>
    </div>
    <div class="header-actions">
      <a class="soft-btn" href="/privacidad.html" target="_blank" rel="noopener">Privacidad</a>
      <button id="moreBtn" class="soft-btn" title="M√°s">‚ãØ</button>
      <button id="closeBtn" class="icon-btn" aria-label="Cerrar">‚úï</button>
    </div>
  </header>

  <div class="chipbar" id="chipbar"></div>

  <main class="chat-body" id="chatBody"></main>

  <div class="toolbar" id="toolbar">
    <button class="tool" id="clearBtn">üßπ Limpiar</button>
    <button class="tool" id="downloadBtn">‚¨áÔ∏è Descargar</button>
    <button class="tool" id="emailBtn">üìß Soporte</button>
  </div>

  <footer class="chat-footer">
    <div class="quick" id="quickRow">
      <button data-q="Cuenta y registro">Cuenta y registro</button>
      <button data-q="Transacciones">Transacciones</button>
      <button data-q="Metas">Metas</button>
      <button data-q="Planes y precios">Planes y precios</button>
    </div>
    <div class="input-row">
      <input id="userInput" type="text" placeholder="Escribe tu pregunta‚Ä¶ (Enter para enviar)" autocomplete="off"/>
      <button id="sendBtn">Enviar</button>
    </div>
  </footer>
</section>

<script>
(async function(){
  const els = {
    launcher: byId('launcher'), chat: byId('chatWindow'), body: byId('chatBody'),
    input: byId('userInput'), send: byId('sendBtn'), close: byId('closeBtn'),
    clear: byId('clearBtn'), download: byId('downloadBtn'), email: byId('emailBtn'),
    quick: byId('quickRow'), chipbar: byId('chipbar'), toolbar: byId('toolbar'),
    more: byId('moreBtn'),
  };
  const STORAGE_KEY = 'cm_chat_history_minimal_v1';

  // Cargar FAQ
  let FAQ = [];
  try{
    const res = await fetch('./faq_cadamenudo.json?v=2', {cache:'no-store'});
    FAQ = await res.json();
  }catch(e){ console.warn('No pude cargar faq_cadamenudo.json', e); }

  // Normalizaci√≥n y categor√≠as
  const norm = s => (s==null?'':String(s)).trim().toLowerCase();
  const catIndex = {};
  FAQ.forEach(it => { const c=norm(it.category); if(!c) return; (catIndex[c]??=[]).push(it); });

  // Chips
  [...new Set(FAQ.map(f => (f.category||'').trim()).filter(Boolean))].forEach(cat=>{
    const b=document.createElement('button'); b.className='chip'; b.textContent=cat; b.dataset.cat=norm(cat);
    b.onclick=()=>suggestByCategory(b.dataset.cat, cat);
    els.chipbar.appendChild(b);
  });

  // Bienvenida
  const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
  saved.forEach(m=>renderMsg(m.role,m.text,m.ts,true));
  if(saved.length===0){
    push('bot','¬°Hola! Soy tu asistente de Cada Menudo. Preg√∫ntame algo o elige una categor√≠a arriba.');
    if(FAQ.length) showTopFAQ();
  }

  // Eventos
  els.launcher.onclick=()=>toggle(true);
  els.close.onclick=()=>toggle(false);
  els.more.onclick=()=> els.toolbar.style.display = els.toolbar.style.display==='flex' ? 'none' : 'flex';
  els.send.onclick=onSend;
  els.input.onkeydown=(e)=>{ if(e.key==='Enter') onSend(); };
  els.quick.addEventListener('click', (e)=>{ if(e.target.matches('button[data-q]')){ els.input.value=e.target.dataset.q; onSend(); }});
  els.clear.onclick=()=>{ state.history=[]; persist(); els.body.innerHTML=''; push('bot','Conversaci√≥n limpiada. ¬øEn qu√© te ayudo ahora?'); if(FAQ.length) showTopFAQ(); };
  els.download.onclick=()=>{ const blob=new Blob([JSON.stringify(state.history,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='chat-cada-menudo.json'; a.click(); URL.revokeObjectURL(url); };
  els.email.onclick=()=>{ location.href=buildSupportEmail(); };

  // Estado
  const state={history:saved};
  function byId(id){ return document.getElementById(id); }
  function toggle(open){ els.chat.style.display=open?'grid':'none'; }
  function push(role,text){ const m={role,text,ts:new Date().toISOString()}; state.history.push(m); renderMsg(role,text,m.ts); persist(); }
  function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.history)); }
  function renderMsg(role,text,ts,skip){ const wrap=document.createElement('div'); wrap.className='msg '+role;
    const b=document.createElement('div'); b.className='bubble'; b.innerHTML=escapeHtml(text).replace(/\n/g,'<br/>');
    const meta=document.createElement('span'); meta.className='meta'; meta.textContent=(role==='bot'?'Asistente':'T√∫')+' ‚Ä¢ '+new Date(ts||Date.now()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    b.appendChild(meta); wrap.appendChild(b); els.body.appendChild(wrap); if(!skip) els.body.scrollTop=els.body.scrollHeight; }
  function escapeHtml(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

  // Manejo
  const intents=[
    {match:/(^|\s)(hola|buenas|hey|saludos)(\s|!|$)/i, reply:'¬°Hola! Puedo ayudarte con cuenta/registro, transacciones, metas y planes.'},
    {match:/(privacidad|privacy|datos|data)/i, reply:'Nuestra pol√≠tica: <a href="/privacidad.html" target="_blank" rel="noopener">Privacidad</a>'},
    {match:/(soporte|ayuda|contacto|email|correo)/i, reply:'Usa el bot√≥n ‚Äúüìß Soporte‚Äù o escribe a <a href="mailto:tech@cadamenudo.com">tech@cadamenudo.com</a>.'},
  ];

  function onSend(){
    const text=(els.input.value||'').trim(); if(!text) return;
    push('user', text); els.input.value='';
    // Intenciones
    for(const it of intents){ if(it.match.test(text)){ push('bot', it.reply); return; } }
    // B√∫squeda FAQ
    const hits=searchFAQ(text);
    if(hits.length){ push('bot', renderFAQ(hits.slice(0,3))); }
    else{ push('bot','No encontr√© una respuesta exacta. Prueba con otra palabra o elige una categor√≠a.'); }
  }

  function tokenize(s){ return (s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^a-z0-9√°√©√≠√≥√∫√±√º\s]/gi,' ').split(/\s+/).filter(Boolean); }
  function score(qTokens,item){ const hay=(item.q+' '+(item.tags||[]).join(' ')+' '+(item.category||'')).toLowerCase(); const set=new Set(tokenize(hay)); let s=0; for(const t of qTokens){ if(set.has(t)) s+=1; } if(item.q.toLowerCase().includes(qTokens.join(' '))) s+=1.5; return s; }
  function searchFAQ(q){ const t=tokenize(q); return FAQ.map(i=>({i,s:score(t,i)})).filter(x=>x.s>0).sort((a,b)=>b.s-a.s).map(x=>x.i); }
  function renderFAQ(items){ return 'Encontr√© esto:<div class="faq-suggest">' + items.map(it=>`<div class="faq-item"><div class="q">‚Ä¢ ${escapeHtml(it.q)}</div><div class="a">${it.a}${it.link?`<div style="margin-top:6px;"><a href="${it.link}" target="_blank" rel="noopener">Abrir</a></div>`:''}</div></div>`).join('') + '</div>'; }
  function suggestByCategory(key,label){ const k=norm(key||label); let items=(catIndex[k]||[]).slice(0,6);
    if(items.length===0){ items=FAQ.filter(f=>norm(f.category).includes(k) || (f.tags||[]).some(t=>norm(t).includes(k)) || norm(f.q).includes(k)).slice(0,6); }
    if(items.length===0){ items=searchFAQ(label||key).slice(0,6); }
    if(items.length) push('bot', `Categor√≠a: <b>${escapeHtml(label||key)}</b><br/>`+renderFAQ(items));
    else push('bot', `No tengo elementos en la categor√≠a <b>${escapeHtml(label||key)}</b> a√∫n.`); }

  function showTopFAQ(){ const top=FAQ.slice(0,3); if(top.length) push('bot', renderFAQ(top)); }

  function buildSupportEmail(){
    const last=state.history.slice(-10).map(m=>`${m.role.toUpperCase()} [${new Date(m.ts).toLocaleString()}]: ${m.text}`).join('\n');
    const ua=navigator.userAgent||'', lang=navigator.language||'';
    const body=`Hola equipo t√©cnico,

Necesito ayuda con el chatbot de Cada Menudo.

Descripci√≥n del problema / pregunta:
(Escribe aqu√≠‚Ä¶)

Contexto (√∫ltimos mensajes):
${last}

Datos t√©cnicos:
- URL: ${location.href}
- Navegador: ${ua}
- Idioma: ${lang}

Gracias.`;
    return `mailto:tech@cadamenudo.com?subject=${encodeURIComponent('Soporte Chatbot ‚Äì Cada Menudo')}&body=${encodeURIComponent(body)}`;
  }

  // Ajuste autom√°tico del logo (no se deforma)
  document.querySelectorAll('.launcher-logo, .bot-logo').forEach(img=>{
    img.addEventListener('load', ()=>{
      const {naturalWidth:w,naturalHeight:h}=img; if(!w||!h) return;
      const r=w/h; img.style.objectFit='contain'; img.style.background='#fff'; img.style.borderRadius='50%';
      img.style.padding = r>1.3 ? '8px' : r<0.8 ? '4px' : '5px';
    });
  });
})();
</script>
</body>
</html>

