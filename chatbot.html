<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chatbot ‚Äì Cada Menudo (Minimal)</title>
<link rel="stylesheet" href="https://cadamenudo.github.io/UI-UX/css-fonts.css"/>

<style>
  :root{
    --primary:#3956E8; --secondary:#7459D9; --accent:#E8C239;
    --bg:#ffffff; --text:#0d1320; --muted:#6b7280; --border:#E6E8F0; --shadow:0 8px 28px rgba(15,23,42,.12);
    --bot:#F3F6FF; --user:#F7F8FB;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:"Greycliff CF",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

  /* Bot√≥n flotante */
  .chat-launcher{
    position:fixed; right:20px; bottom:20px; width:64px; height:64px; border-radius:50%;
    border:none; background:var(--primary); color:#fff; display:grid; place-items:center;
    box-shadow:var(--shadow); cursor:pointer; z-index:9999;
  }
  .launcher-logo{
    width:38px; height:38px; border-radius:50%; background:#fff; padding:6px; object-fit:contain;
  }

  /* Ventana */
  .chat-window{
    position:fixed; right:20px; bottom:92px; width:360px; max-width:92vw; height:560px; max-height:78vh;
    display:none; grid-template-rows:auto auto auto 1fr auto auto;
    background:#fff; border-radius:18px; overflow:hidden; box-shadow:var(--shadow); z-index:9999; border:1px solid var(--border);
  }

  /* Header */
  .chat-header{ display:flex; align-items:center; gap:12px; padding:12px 14px; background:#fff; border-bottom:1px solid var(--border) }
  .bot-logo{ width:32px; height:32px; border-radius:50%; background:#fff; padding:4px; object-fit:contain }
  .chat-title{font-weight:700; color:var(--primary); line-height:1}
  .chat-sub{font-size:12px; color:var(--muted); margin-top:2px}
  .header-actions{margin-left:auto; display:flex; gap:8px; align-items:center}
  .icon-btn{ background:transparent; border:none; color:#94A3B8; font-size:18px; cursor:pointer; padding:6px }

  /* Input arriba */
  .input-top{ padding:10px 12px; border-bottom:1px solid var(--border); background:#fff }
  .input-row{ display:flex; gap:8px }
  .input-row input{ flex:1; padding:12px; border:1px solid var(--border); border-radius:12px; font-size:14px; outline:none; }
  .input-row input::placeholder{ color:#98A2B3; }
  .input-row button{ padding:12px 14px; border:none; border-radius:12px; background:var(--primary); color:#fff; font-weight:700; cursor:pointer }

  /* Categor√≠as */
  .chipbar{display:flex; gap:8px; padding:10px 12px; border-bottom:1px solid var(--border); background:#fff; overflow:auto}
  .chip{border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px; background:#fff; color:#374151; white-space:nowrap}
  .chip:active{transform:scale(.98)}

  /* Cuerpo */
  .chat-body{padding:14px; overflow:auto; background:#fff}
  .msg{display:flex; margin:8px 0}
  .msg.bot{justify-content:flex-start}
  .msg.user{justify-content:flex-end}
  .bubble{ max-width:78%; padding:10px 12px; border-radius:14px; font-size:14px; line-height:1.35; border:1px solid var(--border) }
  .msg.bot .bubble{background:var(--bot)}
  .msg.user .bubble{background:var(--user)}
  .meta{display:block; color:#9AA4B2; font-size:11px; margin-top:4px}

  /* Sugerencias FAQ */
  .faq-suggest{border:1px dashed var(--border); padding:10px; border-radius:12px; background:#fff; margin:8px 0; font-size:13px}
  .faq-item{padding:8px 10px; border:1px solid var(--border); border-radius:10px; margin:8px 0; background:#fff}
  .faq-item .q{font-weight:700; margin-bottom:6px}
  .faq-item .a{font-size:14px}
  .faq-suggest a{color:var(--primary); text-decoration:none}

  /* Toolbar (oculta) */
  .toolbar{display:none; gap:8px; padding:8px 12px; border-top:1px dashed var(--border); background:#fff}
  .tool{font-size:12px; color:#374151; cursor:pointer; border:1px solid var(--border); padding:6px 10px; border-radius:8px; background:#fff}

  /* Footer discreto */
  .chat-footer{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 12px; border-top:1px solid var(--border); background:#fff }
  .privacy-link{ font-size:12px; color:#8A93A6; text-decoration:none }
  .privacy-link:hover{ color:#6B7280; text-decoration:underline }

  /* Dark mode */
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b1020; --text:#E5E7EB; --muted:#9aa4b2; --border:#1f2937; --bot:#0e1830; --user:#0b1326; }
    .chat-window{ background:#0f172a; border-color:var(--border) }
    .chat-header, .input-top, .chipbar, .chat-footer, .toolbar{ background:#0f172a; border-color:var(--border) }
    .chip, .tool{ background:#0b1326; border-color:var(--border); color:#e5e7eb }
    .faq-item{ background:#0b1326; border-color:var(--border) }
    .faq-suggest a{ color:#9fb0ff }
    .input-row input{ background:#0b1326; border-color:var(--border); color:#e5e7eb }
  }

  @media (max-width:480px){
    .chat-window{ right:0; left:0; bottom:0; top:0; width:100vw; height:100vh; max-height:100vh; border-radius:0 }
  }
</style>
</head>
<body>

<button class="chat-launcher" id="launcher" aria-label="Abrir chat">
  <img class="launcher-logo" src="https://cadamenudo.github.io/UI-UX/isotopo%20w-name.png" alt="Cada Menudo"/>
</button>

<section class="chat-window" id="chatWindow" aria-live="polite">
  <header class="chat-header">
    <img class="bot-logo" src="https://cadamenudo.github.io/UI-UX/isotopo%20w-name.png" alt="Cada Menudo"/>
    <div>
      <div class="chat-title">ChinChin Bot</div>
      <div class="chat-sub">Ayuda y preguntas frecuentes</div>
    </div>
    <div class="header-actions">
      <button id="closeBtn" class="icon-btn" aria-label="Cerrar">‚úï</button>
    </div>
  </header>

  <!-- INPUT ARRIBA -->
  <div class="input-top">
    <div class="input-row">
      <input id="userInput" type="text" placeholder="Pregunta" autocomplete="off"/>
      <button id="sendBtn" type="button">Enviar</button>
    </div>
  </div>

  <!-- Categor√≠as -->
  <div class="chipbar" id="chipbar"></div>

  <!-- Conversaci√≥n -->
  <main class="chat-body" id="chatBody"></main>

  <!-- Herramientas -->
  <div class="toolbar" id="toolbar">
    <button class="tool" id="clearBtn">üßπ Limpiar</button>
    <button class="tool" id="downloadBtn">‚¨áÔ∏è Descargar</button>
    <button class="tool" id="emailBtn">üìß Soporte</button>
  </div>

  <!-- Footer discreto -->
  <footer class="chat-footer">
    <a class="privacy-link" href="/privacidad.html" target="_blank" rel="noopener">Privacidad</a>
    <div style="font-size:12px; color:#8A93A6;">Cada Menudo</div>
  </footer>
</section>

<script>
(function(){
  const els = {};
  const STORAGE_KEY = 'cm_chat_history_minimal_v4';

  // ===== Helpers =====
  function byId(id){ return document.getElementById(id); }
  function norm(s){ return (s==null?'':String(s)).trim().toLowerCase(); }
  function tokenize(s){
    return (s||'').toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-z0-9√°√©√≠√≥√∫√±√º\s]/gi,' ')
      .split(/\s+/).filter(Boolean);
  }
  function escapeHtml(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

  // ===== Estado =====
  const state = { history: [] };
  let FAQ = [];
  let catIndex = {};

  // ===== Init =====
  window.addEventListener('DOMContentLoaded', init, { once:true });

  async function init(){
    Object.assign(els, {
      launcher: byId('launcher'), chat: byId('chatWindow'), body: byId('chatBody'),
      input: byId('userInput'), send: byId('sendBtn'), close: byId('closeBtn'),
      clear: byId('clearBtn'), download: byId('downloadBtn'), email: byId('emailBtn'),
      chipbar: byId('chipbar'), toolbar: byId('toolbar')
    });

    // Abrir/cerrar
    els.launcher?.addEventListener('click', () => toggle(true));
    els.close?.addEventListener('click', () => toggle(false));

    // Enviar
    els.send?.addEventListener('click', onSendSafe);
    els.input?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') onSendSafe(); });

    // Herramientas
    els.clear?.addEventListener('click', () => {
      state.history=[]; persist(); els.body.innerHTML='';
      pushHTML('bot','Conversaci√≥n limpiada. ¬øEn qu√© te ayudo ahora?');
      if(FAQ.length) showWelcomeTopics();
    });
    els.download?.addEventListener('click', () => {
      const blob=new Blob([JSON.stringify(state.history,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download='chat-cada-menudo.json'; a.click(); URL.revokeObjectURL(url);
    });
    els.email?.addEventListener('click', () => { location.href = buildSupportEmail(); });

    // Delegaci√≥n: abrir/cerrar respuestas del acorde√≥n
    els.body.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-toggle="qa"]');
      if(!btn) return;
      const id = btn.getAttribute('data-id');
      const ans = els.body.querySelector(`.ans[data-id="${id}"]`);
      if(ans){ ans.classList.toggle('open'); }
    });

    // Carga FAQ
    try{
      const res = await fetch('./faq_cadamenudo.json?v=5', { cache:'no-store' });
      FAQ = await res.json();
    }catch(e){ console.warn('No pude cargar faq_cadamenudo.json', e); FAQ = []; }

    // √çndice de categor√≠as (y filtro para ocultar las tipo "Sheet1/Hoja1/Sheet..")
    const isGarbageCat = c => /^sheet\d*$/i.test(c) || /^hoja\d*$/i.test(c) || /^sheet$/i.test(c);
    catIndex = {};
    FAQ.forEach(it=>{
      const cRaw = (it.category||'').trim();
      if(!cRaw) return;
      if(isGarbageCat(cRaw)) return;        // <-- oculta "Sheet1" y similares
      const c = norm(cRaw);
      (catIndex[c]??=[]).push(it);
    });

    // Chips de categor√≠as (limpias)
    els.chipbar.innerHTML = '';
    Object.keys(catIndex).forEach(key=>{
      const label = Object.values(catIndex[key][0].category || key) ? catIndex[key][0].category : key;
      const b=document.createElement('button');
      b.className='chip'; b.textContent=catIndex[key][0].category || key;
      b.dataset.cat=key;
      b.onclick=()=> showCategoryPanel(key);
      els.chipbar.appendChild(b);
    });

    // Historial y bienvenida
    try{
      const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
      state.history = Array.isArray(saved) ? saved : [];
      state.history.forEach(m=>renderMsg(m.role,m.text,m.ts,true, m.html));
    }catch(_){}
    if(state.history.length===0){
      pushHTML('bot','üëã Hola, soy <b>Chin Chin</b>, tu chatbot de Cada Menudo. Aqu√≠ te pongo los temas que pueden interesarte üëá');
      showWelcomeTopics();
    }

    // Ajuste autom√°tico del logo (no se deforma)
    document.querySelectorAll('.launcher-logo, .bot-logo').forEach(img=>{
      img.addEventListener('load', ()=>{
        const {naturalWidth:w,naturalHeight:h}=img; if(!w||!h) return;
        const r=w/h; img.style.objectFit='contain'; img.style.background='#fff'; img.style.borderRadius='50%';
        img.style.padding = r>1.3 ? '8px' : r<0.8 ? '4px' : '5px';
      });
    });
  }

  // ===== Env√≠o =====
  function onSendSafe(){
    try{
      const text = (els.input?.value || '').trim();
      if(!text) return;
      push('user', text);
      els.input.value = '';
      handle(text);
    }catch(err){
      console.error(err);
      push('bot', 'Ups, tuve un problema procesando tu mensaje. Intenta de nuevo por favor.');
    }
  }

  // ===== Core =====
  function toggle(open){ if(els.chat) els.chat.style.display = open ? 'grid' : 'none'; }
  function push(role, text){ // texto plano
    const m = { role, text, ts:new Date().toISOString(), html:false };
    state.history.push(m);
    renderMsg(role, text, m.ts, false, false);
    persist();
  }
  function pushHTML(role, html){ // texto confiable con HTML
    const m = { role, text: html, ts:new Date().toISOString(), html:true };
    state.history.push(m);
    renderMsg(role, html, m.ts, false, true);
    persist();
  }
  function persist(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.history)); }catch(_){ } }

  function renderMsg(role, text, ts, skip, isHTML){
    const wrap=document.createElement('div');
    wrap.className='msg '+role;
    const b=document.createElement('div');
    b.className='bubble';
    if(isHTML) b.innerHTML = text; else b.innerHTML = escapeHtml(text).replace(/\n/g,'<br/>');
    const meta=document.createElement('span'); meta.className='meta';
    meta.textContent=(role==='bot'?'Asistente':'T√∫')+' ‚Ä¢ '+new Date(ts||Date.now()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    b.appendChild(meta);
    wrap.appendChild(b);
    els.body.appendChild(wrap);
    if(!skip) els.body.scrollTop = els.body.scrollHeight;
  }

  // ===== Bienvenida: botones de temas =====
  function showWelcomeTopics(){
    const topCats = Object.keys(catIndex).slice(0,6);
    if(!topCats.length) return;
    const html = `
      <div class="topic-grid">
        ${topCats.map(k=>`<button class="topic-btn" data-cat="${k}">${escapeHtml(catIndex[k][0].category)}</button>`).join('')}
      </div>`;
    pushHTML('bot', html);
    // Delegaci√≥n para esos botones
    els.body.addEventListener('click', (e)=>{
      const btn = e.target.closest('.topic-btn');
      if(btn){ showCategoryPanel(btn.getAttribute('data-cat')); }
    });
  }

  // ===== Panel de categor√≠a: lista de preguntas clicables (acorde√≥n) =====
  function showCategoryPanel(catKey){
    const items = (catIndex[catKey]||[]).slice(0,20); // muestra las primeras 20 preguntas
    if(!items.length){
      push('bot', 'No tengo preguntas en este tema a√∫n.');
      return;
    }
    const catName = catIndex[catKey][0].category;

    const html = `
      <div class="cat-panel">
        <div class="cat-title">Tema: ${escapeHtml(catName)}</div>
        <div class="q-list">
          ${items.map((it,idx)=>{
            const id = `${catKey}-${idx}`;
            return `
              <div class="q-item">
                <button class="q-btn" data-toggle="qa" data-id="${id}">‚Ä¢ ${escapeHtml(it.q)}</button>
                <div class="ans" data-id="${id}">
                  <div class="ans-inner">${it.a}${it.link?`<div class="ans-link"><a href="${it.link}" target="_blank" rel="noopener">Abrir</a></div>`:''}</div>
                </div>
              </div>`;
          }).join('')}
        </div>
      </div>`;
    pushHTML('bot', html);
  }

  // ===== B√∫squeda directa =====
  function score(qTokens,item){
    const hay=(item.q+' '+(item.tags||[]).join(' ')+' '+(item.category||'')).toLowerCase();
    const set=new Set(tokenize(hay));
    let s=0; for(const t of qTokens){ if(set.has(t)) s+=1; }
    if(item.q.toLowerCase().includes(qTokens.join(' '))) s+=1.5;
    return s;
  }
  function searchFAQ(q){
    const t = tokenize(q);
    return FAQ.map(i=>({i,s:score(t,i)}))
              .filter(x=>x.s>0)
              .sort((a,b)=>b.s-a.s)
              .map(x=>x.i);
  }
  function handle(text){
    // Intenciones m√≠nimas
    if (/(^|\s)(hola|buenas|hey|saludos)(\s|!|$)/i.test(text))
      return push('bot','¬°Hola! ¬øSobre qu√© tema quieres ayuda? Toca un bot√≥n de temas o escribe tu pregunta.');

    const hits = searchFAQ(text);
    if(hits.length){
      pushHTML('bot', renderFAQ(hits.slice(0,5)));
    }else{
      push('bot','No encontr√© una respuesta exacta. Prueba con otra palabra o toca un tema.');
    }
  }
  function renderFAQ(items){
    return '<div class="faq-suggest">' +
      items.map(it=>`<div class="faq-item"><div class="q">‚Ä¢ ${escapeHtml(it.q)}</div><div class="a">${it.a}${it.link?`<div style="margin-top:6px;"><a href="${it.link}" target="_blank" rel="noopener">Abrir</a></div>`:''}</div></div>`).join('') +
      '</div>';
  }

  // ===== Email soporte =====
  function buildSupportEmail(){
    const last=state.history.slice(-10).map(m=>`${m.role.toUpperCase()} [${new Date(m.ts).toLocaleString()}]: ${m.text.replace(/<[^>]+>/g,'')}`).join('\n');
    const ua=navigator.userAgent||'', lang=navigator.language||'';
    const body=`Hola equipo t√©cnico,

Necesito ayuda con el chatbot de Cada Menudo.

Descripci√≥n del problema / pregunta:
(Escribe aqu√≠‚Ä¶)

Contexto (√∫ltimos mensajes):
${last}

Datos t√©cnicos:
- URL: ${location.href}
- Navegador: ${ua}
- Idioma: ${lang}

Gracias.`;
    return `mailto:tech@cadamenudo.com?subject=${encodeURIComponent('Soporte Chatbot ‚Äì Cada Menudo')}&body=${encodeURIComponent(body)}`;
  }
})();
</script>

<style>
/* ===== Estilos para el panel de temas y acorde√≥n ===== */
.topic-grid{
  display:flex; flex-wrap:wrap; gap:8px; margin-top:4px;
}
.topic-btn{
  border:1px solid var(--border); background:#fff; color:#374151;
  padding:8px 12px; border-radius:999px; font-size:12px; cursor:pointer;
}
.cat-panel{ border:1px dashed var(--border); background:#fff; border-radius:12px; padding:10px; }
.cat-title{ font-weight:700; color:#3956E8; margin-bottom:6px; }
.q-list{ display:flex; flex-direction:column; gap:6px; }
.q-item{ border:1px solid var(--border); border-radius:10px; background:#fff; }
.q-btn{
  width:100%; text-align:left; background:#fff; border:none; cursor:pointer;
  padding:10px 12px; font-size:14px; color:#0d1320; border-radius:10px;
}
.q-btn:hover{ background:#F7F8FB; }
.ans{ display:none; border-top:1px solid var(--border); }
.ans.open{ display:block; }
.ans-inner{ padding:10px 12px; font-size:14px; background:#F9FAFB; border-radius:0 0 10px 10px; }
.ans-link a{ color:var(--primary); text-decoration:none; }
</style>

</body>
</html>
